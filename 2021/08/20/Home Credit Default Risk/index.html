<!DOCTYPE html>


<html lang="en">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Home Credit Default Risk |  Woody</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 

      <!-- mermaid -->
      
      <script src="https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js"></script>
      
    <link rel="alternate" href="/atom.xml" title="Woody" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Home Credit Default Risk"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Home Credit Default Risk
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/08/20/Home%20Credit%20Default%20Risk/" class="article-date">
  <time datetime="2021-08-19T17:00:41.932Z" itemprop="datePublished">2021-08-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">11.8k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">62 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelEncoder</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"></span><br><span class="line">warnings.filterwarnings(<span class="string">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="数据读取"><a href="#数据读取" class="headerlink" title="数据读取"></a>数据读取</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app_train = pd.read_csv(<span class="string">&#x27;./dataset/application_train.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training data shape: &#x27;</span>, app_train.shape)</span><br><span class="line"></span><br><span class="line">app_train.head()</span><br></pre></td></tr></table></figure>

<pre><code>Training data shape:  (307511, 122)
</code></pre>
<span id="more"></span>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SK_ID_CURR</th>
      <th>TARGET</th>
      <th>NAME_CONTRACT_TYPE</th>
      <th>CODE_GENDER</th>
      <th>FLAG_OWN_CAR</th>
      <th>FLAG_OWN_REALTY</th>
      <th>CNT_CHILDREN</th>
      <th>AMT_INCOME_TOTAL</th>
      <th>AMT_CREDIT</th>
      <th>AMT_ANNUITY</th>
      <th>...</th>
      <th>FLAG_DOCUMENT_18</th>
      <th>FLAG_DOCUMENT_19</th>
      <th>FLAG_DOCUMENT_20</th>
      <th>FLAG_DOCUMENT_21</th>
      <th>AMT_REQ_CREDIT_BUREAU_HOUR</th>
      <th>AMT_REQ_CREDIT_BUREAU_DAY</th>
      <th>AMT_REQ_CREDIT_BUREAU_WEEK</th>
      <th>AMT_REQ_CREDIT_BUREAU_MON</th>
      <th>AMT_REQ_CREDIT_BUREAU_QRT</th>
      <th>AMT_REQ_CREDIT_BUREAU_YEAR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>100002</td>
      <td>1</td>
      <td>Cash loans</td>
      <td>M</td>
      <td>N</td>
      <td>Y</td>
      <td>0</td>
      <td>202500.0</td>
      <td>406597.5</td>
      <td>24700.5</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>100003</td>
      <td>0</td>
      <td>Cash loans</td>
      <td>F</td>
      <td>N</td>
      <td>N</td>
      <td>0</td>
      <td>270000.0</td>
      <td>1293502.5</td>
      <td>35698.5</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>100004</td>
      <td>0</td>
      <td>Revolving loans</td>
      <td>M</td>
      <td>Y</td>
      <td>Y</td>
      <td>0</td>
      <td>67500.0</td>
      <td>135000.0</td>
      <td>6750.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>100006</td>
      <td>0</td>
      <td>Cash loans</td>
      <td>F</td>
      <td>N</td>
      <td>Y</td>
      <td>0</td>
      <td>135000.0</td>
      <td>312682.5</td>
      <td>29686.5</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>100007</td>
      <td>0</td>
      <td>Cash loans</td>
      <td>M</td>
      <td>N</td>
      <td>Y</td>
      <td>0</td>
      <td>121500.0</td>
      <td>513000.0</td>
      <td>21865.5</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 122 columns</p>
</div>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app_test = pd.read_csv(<span class="string">&#x27;./dataset/application_test.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Testing data shape: &#x27;</span>, app_test.shape)</span><br><span class="line"></span><br><span class="line">app_test.head()</span><br></pre></td></tr></table></figure>

<pre><code>Testing data shape:  (48744, 121)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SK_ID_CURR</th>
      <th>NAME_CONTRACT_TYPE</th>
      <th>CODE_GENDER</th>
      <th>FLAG_OWN_CAR</th>
      <th>FLAG_OWN_REALTY</th>
      <th>CNT_CHILDREN</th>
      <th>AMT_INCOME_TOTAL</th>
      <th>AMT_CREDIT</th>
      <th>AMT_ANNUITY</th>
      <th>AMT_GOODS_PRICE</th>
      <th>...</th>
      <th>FLAG_DOCUMENT_18</th>
      <th>FLAG_DOCUMENT_19</th>
      <th>FLAG_DOCUMENT_20</th>
      <th>FLAG_DOCUMENT_21</th>
      <th>AMT_REQ_CREDIT_BUREAU_HOUR</th>
      <th>AMT_REQ_CREDIT_BUREAU_DAY</th>
      <th>AMT_REQ_CREDIT_BUREAU_WEEK</th>
      <th>AMT_REQ_CREDIT_BUREAU_MON</th>
      <th>AMT_REQ_CREDIT_BUREAU_QRT</th>
      <th>AMT_REQ_CREDIT_BUREAU_YEAR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>100001</td>
      <td>Cash loans</td>
      <td>F</td>
      <td>N</td>
      <td>Y</td>
      <td>0</td>
      <td>135000.0</td>
      <td>568800.0</td>
      <td>20560.5</td>
      <td>450000.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>100005</td>
      <td>Cash loans</td>
      <td>M</td>
      <td>N</td>
      <td>Y</td>
      <td>0</td>
      <td>99000.0</td>
      <td>222768.0</td>
      <td>17370.0</td>
      <td>180000.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>100013</td>
      <td>Cash loans</td>
      <td>M</td>
      <td>Y</td>
      <td>Y</td>
      <td>0</td>
      <td>202500.0</td>
      <td>663264.0</td>
      <td>69777.0</td>
      <td>630000.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>100028</td>
      <td>Cash loans</td>
      <td>F</td>
      <td>N</td>
      <td>Y</td>
      <td>2</td>
      <td>315000.0</td>
      <td>1575000.0</td>
      <td>49018.5</td>
      <td>1575000.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>100038</td>
      <td>Cash loans</td>
      <td>M</td>
      <td>Y</td>
      <td>N</td>
      <td>1</td>
      <td>180000.0</td>
      <td>625500.0</td>
      <td>32067.0</td>
      <td>625500.0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 121 columns</p>
</div>



<h2 id="Exploratory-Data-Analysis-EDA-数据探索性分析"><a href="#Exploratory-Data-Analysis-EDA-数据探索性分析" class="headerlink" title="Exploratory Data Analysis(EDA):数据探索性分析"></a>Exploratory Data Analysis(EDA):数据探索性分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看类别分布状况</span></span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;TARGET&#x27;</span>].value_counts()</span><br></pre></td></tr></table></figure>




<pre><code>0    282686
1     24825
Name: TARGET, dtype: int64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app_train[<span class="string">&#x27;TARGET&#x27;</span>].astype(<span class="built_in">int</span>).plot.hist()</span><br></pre></td></tr></table></figure>




<pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x210807715f8&gt;
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqvXfx"><img src="https://z3.ax1x.com/2021/08/19/fqvXfx.png" alt="fqvXfx.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查缺失值</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">missing_values_table</span>(<span class="params">df</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每列特征的缺失值数目</span></span><br><span class="line"></span><br><span class="line">        mis_val = df.isnull().<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每列特征缺失值的百分比</span></span><br><span class="line"></span><br><span class="line">        mis_val_percent = <span class="number">100</span> * df.isnull().<span class="built_in">sum</span>() / <span class="built_in">len</span>(df)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 拼接上述两列，axis=1左右连接，axis=0上下连接</span></span><br><span class="line"></span><br><span class="line">        mis_val_table = pd.concat([mis_val, mis_val_percent], axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 重置列名</span></span><br><span class="line"></span><br><span class="line">        mis_val_table_ren_columns = mis_val_table.rename(</span><br><span class="line"></span><br><span class="line">        columns = &#123;<span class="number">0</span> : <span class="string">&#x27;Missing Values&#x27;</span>, <span class="number">1</span> : <span class="string">&#x27;% of Total Values&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 按特征缺失率排序，ascending=True按升序排列，Fasle降序排列，round()保留几位小数</span></span><br><span class="line"></span><br><span class="line">        mis_val_table_ren_columns = mis_val_table_ren_columns[</span><br><span class="line"></span><br><span class="line">            mis_val_table_ren_columns.iloc[:,<span class="number">1</span>] != <span class="number">0</span>].sort_values(</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;% of Total Values&#x27;</span>, ascending=<span class="literal">False</span>).<span class="built_in">round</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 输出总结信息</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;Your selected dataframe has &quot;</span> + <span class="built_in">str</span>(df.shape[<span class="number">1</span>]) + <span class="string">&quot; columns.\n&quot;</span>      </span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;There are &quot;</span> + <span class="built_in">str</span>(mis_val_table_ren_columns.shape[<span class="number">0</span>]) +</span><br><span class="line"></span><br><span class="line">              <span class="string">&quot; columns that have missing values.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 返回缺失信息</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mis_val_table_ren_columns</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 训练集数据缺失情况，对于缺失值可采取填补措施，对于缺失率很高的列可删除，在此处暂时保留</span></span><br><span class="line"></span><br><span class="line">missing_values = missing_values_table(app_train)</span><br><span class="line"></span><br><span class="line">missing_values.head(<span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<pre><code>Your selected dataframe has 122 columns.
There are 67 columns that have missing values.
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Missing Values</th>
      <th>% of Total Values</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>COMMONAREA_MEDI</th>
      <td>214865</td>
      <td>69.9</td>
    </tr>
    <tr>
      <th>COMMONAREA_AVG</th>
      <td>214865</td>
      <td>69.9</td>
    </tr>
    <tr>
      <th>COMMONAREA_MODE</th>
      <td>214865</td>
      <td>69.9</td>
    </tr>
    <tr>
      <th>NONLIVINGAPARTMENTS_MEDI</th>
      <td>213514</td>
      <td>69.4</td>
    </tr>
    <tr>
      <th>NONLIVINGAPARTMENTS_MODE</th>
      <td>213514</td>
      <td>69.4</td>
    </tr>
    <tr>
      <th>NONLIVINGAPARTMENTS_AVG</th>
      <td>213514</td>
      <td>69.4</td>
    </tr>
    <tr>
      <th>FONDKAPREMONT_MODE</th>
      <td>210295</td>
      <td>68.4</td>
    </tr>
    <tr>
      <th>LIVINGAPARTMENTS_MODE</th>
      <td>210199</td>
      <td>68.4</td>
    </tr>
    <tr>
      <th>LIVINGAPARTMENTS_MEDI</th>
      <td>210199</td>
      <td>68.4</td>
    </tr>
    <tr>
      <th>LIVINGAPARTMENTS_AVG</th>
      <td>210199</td>
      <td>68.4</td>
    </tr>
    <tr>
      <th>FLOORSMIN_MODE</th>
      <td>208642</td>
      <td>67.8</td>
    </tr>
    <tr>
      <th>FLOORSMIN_MEDI</th>
      <td>208642</td>
      <td>67.8</td>
    </tr>
    <tr>
      <th>FLOORSMIN_AVG</th>
      <td>208642</td>
      <td>67.8</td>
    </tr>
    <tr>
      <th>YEARS_BUILD_MODE</th>
      <td>204488</td>
      <td>66.5</td>
    </tr>
    <tr>
      <th>YEARS_BUILD_MEDI</th>
      <td>204488</td>
      <td>66.5</td>
    </tr>
    <tr>
      <th>YEARS_BUILD_AVG</th>
      <td>204488</td>
      <td>66.5</td>
    </tr>
    <tr>
      <th>OWN_CAR_AGE</th>
      <td>202929</td>
      <td>66.0</td>
    </tr>
    <tr>
      <th>LANDAREA_AVG</th>
      <td>182590</td>
      <td>59.4</td>
    </tr>
    <tr>
      <th>LANDAREA_MEDI</th>
      <td>182590</td>
      <td>59.4</td>
    </tr>
    <tr>
      <th>LANDAREA_MODE</th>
      <td>182590</td>
      <td>59.4</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看各类型数据的列数</span></span><br><span class="line"></span><br><span class="line">app_train.dtypes.value_counts()</span><br></pre></td></tr></table></figure>




<pre><code>float64    65
int64      41
object     16
dtype: int64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看对象类型中唯一值的数目</span></span><br><span class="line"></span><br><span class="line">app_train.select_dtypes(<span class="string">&#x27;object&#x27;</span>).apply(pd.Series.nunique, axis = <span class="number">0</span>)</span><br></pre></td></tr></table></figure>




<pre><code>NAME_CONTRACT_TYPE             2
CODE_GENDER                    3
FLAG_OWN_CAR                   2
FLAG_OWN_REALTY                2
NAME_TYPE_SUITE                7
NAME_INCOME_TYPE               8
NAME_EDUCATION_TYPE            5
NAME_FAMILY_STATUS             6
NAME_HOUSING_TYPE              6
OCCUPATION_TYPE               18
WEEKDAY_APPR_PROCESS_START     7
ORGANIZATION_TYPE             58
FONDKAPREMONT_MODE             4
HOUSETYPE_MODE                 3
WALLSMATERIAL_MODE             7
EMERGENCYSTATE_MODE            2
dtype: int64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将对象类型进行编码，建议采用One-hot encoding避免标签编码带来的数值大小问题对预测结果产生影响</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此处对于只有两个类别变量的特征采用标签编码，对于有两个及以上类别变量的特征采用独热编码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 独热编码后数据维度会明显上升，可能需要降维算法删除相关度较高的特征和对结果几乎没有影响的垃圾特征</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用scikit-learn LabelEncoder()进行标签编码</span></span><br><span class="line"></span><br><span class="line">le = LabelEncoder()</span><br><span class="line"></span><br><span class="line">le_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> app_train:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> app_train[col].dtype == <span class="string">&#x27;object&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(app_train[col].unique())) &lt;= <span class="number">2</span>:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 在训练集上训练编码器</span></span><br><span class="line"></span><br><span class="line">            le.fit(app_train[col])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 并在训练集和测试集上分别编码转换</span></span><br><span class="line"></span><br><span class="line">            app_train[col] = le.transform(app_train[col])</span><br><span class="line"></span><br><span class="line">            app_test[col] = le.transform(app_test[col])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 计数有多少个特征被转换</span></span><br><span class="line"></span><br><span class="line">            le_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;%d columns were label encoded.&#x27;</span> % le_count)</span><br></pre></td></tr></table></figure>

<pre><code>3 columns were label encoded.
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 利用pandas get_dummies实现独热编码</span></span><br><span class="line"></span><br><span class="line">app_train = pd.get_dummies(app_train)</span><br><span class="line"></span><br><span class="line">app_test = pd.get_dummies(app_test)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training Features shape: &#x27;</span>, app_train.shape)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Testing Features shape: &#x27;</span>, app_test.shape)</span><br></pre></td></tr></table></figure>

<pre><code>Training Features shape:  (307511, 243)
Testing Features shape:  (48744, 239)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过shape可以观察到训练集测试集的特征数量不同，因此需要删除在训练集中而不在测试集中的特征列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过pandas将训练集和测试集对齐</span></span><br><span class="line"></span><br><span class="line">train_labels = app_train[<span class="string">&#x27;TARGET&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># axis=1按columns对齐，inner内连接只保留匹配的项，outer保留双方所有的数据，没有的列补NAN</span></span><br><span class="line"></span><br><span class="line">app_train, app_test = app_train.align(app_test, join = <span class="string">&#x27;inner&#x27;</span>, axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将第一步取出的label重新加入处理后的训练集</span></span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;TARGET&#x27;</span>] = train_labels</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training Features shape: &#x27;</span>, app_train.shape)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Testing Features shape: &#x27;</span>, app_test.shape)</span><br></pre></td></tr></table></figure>

<pre><code>Training Features shape:  (307511, 240)
Testing Features shape:  (48744, 239)
</code></pre>
<ul>
<li><p>异常值处理</p>
<ul>
<li><p>本项目中大部分特征均为金额，不存在异常情况因此该部分仅作为示例，不作为实际处理</p>
</li>
<li><p>本项目中异常值主要关注日期信息</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">numerical_fea = <span class="built_in">list</span>(app_train.select_dtypes(exclude=[<span class="string">&#x27;object&#x27;</span>]).columns)</span><br><span class="line"></span><br><span class="line">numerical_fea</span><br></pre></td></tr></table></figure>




<pre><code>[&#39;SK_ID_CURR&#39;,
 &#39;NAME_CONTRACT_TYPE&#39;,
 &#39;FLAG_OWN_CAR&#39;,
 &#39;FLAG_OWN_REALTY&#39;,
 &#39;CNT_CHILDREN&#39;,
 &#39;AMT_INCOME_TOTAL&#39;,
 &#39;AMT_CREDIT&#39;,
 &#39;AMT_ANNUITY&#39;,
 &#39;AMT_GOODS_PRICE&#39;,
 &#39;REGION_POPULATION_RELATIVE&#39;,
 &#39;DAYS_BIRTH&#39;,
 &#39;DAYS_EMPLOYED&#39;,
 &#39;DAYS_REGISTRATION&#39;,
 &#39;DAYS_ID_PUBLISH&#39;,
 &#39;OWN_CAR_AGE&#39;,
 &#39;FLAG_MOBIL&#39;,
 &#39;FLAG_EMP_PHONE&#39;,
 &#39;FLAG_WORK_PHONE&#39;,
 &#39;FLAG_CONT_MOBILE&#39;,
 &#39;FLAG_PHONE&#39;,
 &#39;FLAG_EMAIL&#39;,
 &#39;CNT_FAM_MEMBERS&#39;,
 &#39;REGION_RATING_CLIENT&#39;,
 &#39;REGION_RATING_CLIENT_W_CITY&#39;,
 &#39;HOUR_APPR_PROCESS_START&#39;,
 &#39;REG_REGION_NOT_LIVE_REGION&#39;,
 &#39;REG_REGION_NOT_WORK_REGION&#39;,
 &#39;LIVE_REGION_NOT_WORK_REGION&#39;,
 &#39;REG_CITY_NOT_LIVE_CITY&#39;,
 &#39;REG_CITY_NOT_WORK_CITY&#39;,
 &#39;LIVE_CITY_NOT_WORK_CITY&#39;,
 &#39;EXT_SOURCE_1&#39;,
 &#39;EXT_SOURCE_2&#39;,
 &#39;EXT_SOURCE_3&#39;,
 &#39;APARTMENTS_AVG&#39;,
 &#39;BASEMENTAREA_AVG&#39;,
 &#39;YEARS_BEGINEXPLUATATION_AVG&#39;,
 &#39;YEARS_BUILD_AVG&#39;,
 &#39;COMMONAREA_AVG&#39;,
 &#39;ELEVATORS_AVG&#39;,
 &#39;ENTRANCES_AVG&#39;,
 &#39;FLOORSMAX_AVG&#39;,
 &#39;FLOORSMIN_AVG&#39;,
 &#39;LANDAREA_AVG&#39;,
 &#39;LIVINGAPARTMENTS_AVG&#39;,
 &#39;LIVINGAREA_AVG&#39;,
 &#39;NONLIVINGAPARTMENTS_AVG&#39;,
 &#39;NONLIVINGAREA_AVG&#39;,
 &#39;APARTMENTS_MODE&#39;,
 &#39;BASEMENTAREA_MODE&#39;,
 &#39;YEARS_BEGINEXPLUATATION_MODE&#39;,
 &#39;YEARS_BUILD_MODE&#39;,
 &#39;COMMONAREA_MODE&#39;,
 &#39;ELEVATORS_MODE&#39;,
 &#39;ENTRANCES_MODE&#39;,
 &#39;FLOORSMAX_MODE&#39;,
 &#39;FLOORSMIN_MODE&#39;,
 &#39;LANDAREA_MODE&#39;,
 &#39;LIVINGAPARTMENTS_MODE&#39;,
 &#39;LIVINGAREA_MODE&#39;,
 &#39;NONLIVINGAPARTMENTS_MODE&#39;,
 &#39;NONLIVINGAREA_MODE&#39;,
 &#39;APARTMENTS_MEDI&#39;,
 &#39;BASEMENTAREA_MEDI&#39;,
 &#39;YEARS_BEGINEXPLUATATION_MEDI&#39;,
 &#39;YEARS_BUILD_MEDI&#39;,
 &#39;COMMONAREA_MEDI&#39;,
 &#39;ELEVATORS_MEDI&#39;,
 &#39;ENTRANCES_MEDI&#39;,
 &#39;FLOORSMAX_MEDI&#39;,
 &#39;FLOORSMIN_MEDI&#39;,
 &#39;LANDAREA_MEDI&#39;,
 &#39;LIVINGAPARTMENTS_MEDI&#39;,
 &#39;LIVINGAREA_MEDI&#39;,
 &#39;NONLIVINGAPARTMENTS_MEDI&#39;,
 &#39;NONLIVINGAREA_MEDI&#39;,
 &#39;TOTALAREA_MODE&#39;,
 &#39;OBS_30_CNT_SOCIAL_CIRCLE&#39;,
 &#39;DEF_30_CNT_SOCIAL_CIRCLE&#39;,
 &#39;OBS_60_CNT_SOCIAL_CIRCLE&#39;,
 &#39;DEF_60_CNT_SOCIAL_CIRCLE&#39;,
 &#39;DAYS_LAST_PHONE_CHANGE&#39;,
 &#39;FLAG_DOCUMENT_2&#39;,
 &#39;FLAG_DOCUMENT_3&#39;,
 &#39;FLAG_DOCUMENT_4&#39;,
 &#39;FLAG_DOCUMENT_5&#39;,
 &#39;FLAG_DOCUMENT_6&#39;,
 &#39;FLAG_DOCUMENT_7&#39;,
 &#39;FLAG_DOCUMENT_8&#39;,
 &#39;FLAG_DOCUMENT_9&#39;,
 &#39;FLAG_DOCUMENT_10&#39;,
 &#39;FLAG_DOCUMENT_11&#39;,
 &#39;FLAG_DOCUMENT_12&#39;,
 &#39;FLAG_DOCUMENT_13&#39;,
 &#39;FLAG_DOCUMENT_14&#39;,
 &#39;FLAG_DOCUMENT_15&#39;,
 &#39;FLAG_DOCUMENT_16&#39;,
 &#39;FLAG_DOCUMENT_17&#39;,
 &#39;FLAG_DOCUMENT_18&#39;,
 &#39;FLAG_DOCUMENT_19&#39;,
 &#39;FLAG_DOCUMENT_20&#39;,
 &#39;FLAG_DOCUMENT_21&#39;,
 &#39;AMT_REQ_CREDIT_BUREAU_HOUR&#39;,
 &#39;AMT_REQ_CREDIT_BUREAU_DAY&#39;,
 &#39;AMT_REQ_CREDIT_BUREAU_WEEK&#39;,
 &#39;AMT_REQ_CREDIT_BUREAU_MON&#39;,
 &#39;AMT_REQ_CREDIT_BUREAU_QRT&#39;,
 &#39;AMT_REQ_CREDIT_BUREAU_YEAR&#39;,
 &#39;CODE_GENDER_F&#39;,
 &#39;CODE_GENDER_M&#39;,
 &#39;NAME_TYPE_SUITE_Children&#39;,
 &#39;NAME_TYPE_SUITE_Family&#39;,
 &#39;NAME_TYPE_SUITE_Group of people&#39;,
 &#39;NAME_TYPE_SUITE_Other_A&#39;,
 &#39;NAME_TYPE_SUITE_Other_B&#39;,
 &#39;NAME_TYPE_SUITE_Spouse, partner&#39;,
 &#39;NAME_TYPE_SUITE_Unaccompanied&#39;,
 &#39;NAME_INCOME_TYPE_Businessman&#39;,
 &#39;NAME_INCOME_TYPE_Commercial associate&#39;,
 &#39;NAME_INCOME_TYPE_Pensioner&#39;,
 &#39;NAME_INCOME_TYPE_State servant&#39;,
 &#39;NAME_INCOME_TYPE_Student&#39;,
 &#39;NAME_INCOME_TYPE_Unemployed&#39;,
 &#39;NAME_INCOME_TYPE_Working&#39;,
 &#39;NAME_EDUCATION_TYPE_Academic degree&#39;,
 &#39;NAME_EDUCATION_TYPE_Higher education&#39;,
 &#39;NAME_EDUCATION_TYPE_Incomplete higher&#39;,
 &#39;NAME_EDUCATION_TYPE_Lower secondary&#39;,
 &#39;NAME_EDUCATION_TYPE_Secondary / secondary special&#39;,
 &#39;NAME_FAMILY_STATUS_Civil marriage&#39;,
 &#39;NAME_FAMILY_STATUS_Married&#39;,
 &#39;NAME_FAMILY_STATUS_Separated&#39;,
 &#39;NAME_FAMILY_STATUS_Single / not married&#39;,
 &#39;NAME_FAMILY_STATUS_Widow&#39;,
 &#39;NAME_HOUSING_TYPE_Co-op apartment&#39;,
 &#39;NAME_HOUSING_TYPE_House / apartment&#39;,
 &#39;NAME_HOUSING_TYPE_Municipal apartment&#39;,
 &#39;NAME_HOUSING_TYPE_Office apartment&#39;,
 &#39;NAME_HOUSING_TYPE_Rented apartment&#39;,
 &#39;NAME_HOUSING_TYPE_With parents&#39;,
 &#39;OCCUPATION_TYPE_Accountants&#39;,
 &#39;OCCUPATION_TYPE_Cleaning staff&#39;,
 &#39;OCCUPATION_TYPE_Cooking staff&#39;,
 &#39;OCCUPATION_TYPE_Core staff&#39;,
 &#39;OCCUPATION_TYPE_Drivers&#39;,
 &#39;OCCUPATION_TYPE_HR staff&#39;,
 &#39;OCCUPATION_TYPE_High skill tech staff&#39;,
 &#39;OCCUPATION_TYPE_IT staff&#39;,
 &#39;OCCUPATION_TYPE_Laborers&#39;,
 &#39;OCCUPATION_TYPE_Low-skill Laborers&#39;,
 &#39;OCCUPATION_TYPE_Managers&#39;,
 &#39;OCCUPATION_TYPE_Medicine staff&#39;,
 &#39;OCCUPATION_TYPE_Private service staff&#39;,
 &#39;OCCUPATION_TYPE_Realty agents&#39;,
 &#39;OCCUPATION_TYPE_Sales staff&#39;,
 &#39;OCCUPATION_TYPE_Secretaries&#39;,
 &#39;OCCUPATION_TYPE_Security staff&#39;,
 &#39;OCCUPATION_TYPE_Waiters/barmen staff&#39;,
 &#39;WEEKDAY_APPR_PROCESS_START_FRIDAY&#39;,
 &#39;WEEKDAY_APPR_PROCESS_START_MONDAY&#39;,
 &#39;WEEKDAY_APPR_PROCESS_START_SATURDAY&#39;,
 &#39;WEEKDAY_APPR_PROCESS_START_SUNDAY&#39;,
 &#39;WEEKDAY_APPR_PROCESS_START_THURSDAY&#39;,
 &#39;WEEKDAY_APPR_PROCESS_START_TUESDAY&#39;,
 &#39;WEEKDAY_APPR_PROCESS_START_WEDNESDAY&#39;,
 &#39;ORGANIZATION_TYPE_Advertising&#39;,
 &#39;ORGANIZATION_TYPE_Agriculture&#39;,
 &#39;ORGANIZATION_TYPE_Bank&#39;,
 &#39;ORGANIZATION_TYPE_Business Entity Type 1&#39;,
 &#39;ORGANIZATION_TYPE_Business Entity Type 2&#39;,
 &#39;ORGANIZATION_TYPE_Business Entity Type 3&#39;,
 &#39;ORGANIZATION_TYPE_Cleaning&#39;,
 &#39;ORGANIZATION_TYPE_Construction&#39;,
 &#39;ORGANIZATION_TYPE_Culture&#39;,
 &#39;ORGANIZATION_TYPE_Electricity&#39;,
 &#39;ORGANIZATION_TYPE_Emergency&#39;,
 &#39;ORGANIZATION_TYPE_Government&#39;,
 &#39;ORGANIZATION_TYPE_Hotel&#39;,
 &#39;ORGANIZATION_TYPE_Housing&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 1&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 10&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 11&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 12&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 13&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 2&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 3&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 4&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 5&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 6&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 7&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 8&#39;,
 &#39;ORGANIZATION_TYPE_Industry: type 9&#39;,
 &#39;ORGANIZATION_TYPE_Insurance&#39;,
 &#39;ORGANIZATION_TYPE_Kindergarten&#39;,
 &#39;ORGANIZATION_TYPE_Legal Services&#39;,
 &#39;ORGANIZATION_TYPE_Medicine&#39;,
 &#39;ORGANIZATION_TYPE_Military&#39;,
 &#39;ORGANIZATION_TYPE_Mobile&#39;,
 &#39;ORGANIZATION_TYPE_Other&#39;,
 &#39;ORGANIZATION_TYPE_Police&#39;,
 &#39;ORGANIZATION_TYPE_Postal&#39;,
 &#39;ORGANIZATION_TYPE_Realtor&#39;,
 &#39;ORGANIZATION_TYPE_Religion&#39;,
 &#39;ORGANIZATION_TYPE_Restaurant&#39;,
 &#39;ORGANIZATION_TYPE_School&#39;,
 &#39;ORGANIZATION_TYPE_Security&#39;,
 &#39;ORGANIZATION_TYPE_Security Ministries&#39;,
 &#39;ORGANIZATION_TYPE_Self-employed&#39;,
 &#39;ORGANIZATION_TYPE_Services&#39;,
 &#39;ORGANIZATION_TYPE_Telecom&#39;,
 &#39;ORGANIZATION_TYPE_Trade: type 1&#39;,
 &#39;ORGANIZATION_TYPE_Trade: type 2&#39;,
 &#39;ORGANIZATION_TYPE_Trade: type 3&#39;,
 &#39;ORGANIZATION_TYPE_Trade: type 4&#39;,
 &#39;ORGANIZATION_TYPE_Trade: type 5&#39;,
 &#39;ORGANIZATION_TYPE_Trade: type 6&#39;,
 &#39;ORGANIZATION_TYPE_Trade: type 7&#39;,
 &#39;ORGANIZATION_TYPE_Transport: type 1&#39;,
 &#39;ORGANIZATION_TYPE_Transport: type 2&#39;,
 &#39;ORGANIZATION_TYPE_Transport: type 3&#39;,
 &#39;ORGANIZATION_TYPE_Transport: type 4&#39;,
 &#39;ORGANIZATION_TYPE_University&#39;,
 &#39;ORGANIZATION_TYPE_XNA&#39;,
 &#39;FONDKAPREMONT_MODE_not specified&#39;,
 &#39;FONDKAPREMONT_MODE_org spec account&#39;,
 &#39;FONDKAPREMONT_MODE_reg oper account&#39;,
 &#39;FONDKAPREMONT_MODE_reg oper spec account&#39;,
 &#39;HOUSETYPE_MODE_block of flats&#39;,
 &#39;HOUSETYPE_MODE_specific housing&#39;,
 &#39;HOUSETYPE_MODE_terraced house&#39;,
 &#39;WALLSMATERIAL_MODE_Block&#39;,
 &#39;WALLSMATERIAL_MODE_Mixed&#39;,
 &#39;WALLSMATERIAL_MODE_Monolithic&#39;,
 &#39;WALLSMATERIAL_MODE_Others&#39;,
 &#39;WALLSMATERIAL_MODE_Panel&#39;,
 &#39;WALLSMATERIAL_MODE_Stone, brick&#39;,
 &#39;WALLSMATERIAL_MODE_Wooden&#39;,
 &#39;EMERGENCYSTATE_MODE_No&#39;,
 &#39;EMERGENCYSTATE_MODE_Yes&#39;,
 &#39;TARGET&#39;]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3segama异常值检测函数，添加异常值指示列</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_outliers_by_3segama</span>(<span class="params">data,fea</span>):</span></span><br><span class="line"></span><br><span class="line">    data_std = np.std(data[fea])</span><br><span class="line"></span><br><span class="line">    data_mean = np.mean(data[fea])</span><br><span class="line"></span><br><span class="line">    outliers_cut_off = data_std * <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    lower_rule = data_mean - outliers_cut_off</span><br><span class="line"></span><br><span class="line">    upper_rule = data_mean + outliers_cut_off</span><br><span class="line"></span><br><span class="line">    data[fea+<span class="string">&#x27;_outliers&#x27;</span>] = data[fea].apply(<span class="keyword">lambda</span> x:<span class="built_in">str</span>(<span class="string">&#x27;异常值&#x27;</span>) <span class="keyword">if</span> x &gt; upper_rule <span class="keyword">or</span> x &lt; lower_rule <span class="keyword">else</span> <span class="string">&#x27;正常值&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异常值详情</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> fea <span class="keyword">in</span> numerical_fea:</span><br><span class="line"></span><br><span class="line">    outlier_train = find_outliers_by_3segama(app_train,fea)</span><br><span class="line"></span><br><span class="line">outlier_train</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SK_ID_CURR</th>
      <th>NAME_CONTRACT_TYPE</th>
      <th>FLAG_OWN_CAR</th>
      <th>FLAG_OWN_REALTY</th>
      <th>CNT_CHILDREN</th>
      <th>AMT_INCOME_TOTAL</th>
      <th>AMT_CREDIT</th>
      <th>AMT_ANNUITY</th>
      <th>AMT_GOODS_PRICE</th>
      <th>REGION_POPULATION_RELATIVE</th>
      <th>...</th>
      <th>WALLSMATERIAL_MODE_Block_outliers</th>
      <th>WALLSMATERIAL_MODE_Mixed_outliers</th>
      <th>WALLSMATERIAL_MODE_Monolithic_outliers</th>
      <th>WALLSMATERIAL_MODE_Others_outliers</th>
      <th>WALLSMATERIAL_MODE_Panel_outliers</th>
      <th>WALLSMATERIAL_MODE_Stone, brick_outliers</th>
      <th>WALLSMATERIAL_MODE_Wooden_outliers</th>
      <th>EMERGENCYSTATE_MODE_No_outliers</th>
      <th>EMERGENCYSTATE_MODE_Yes_outliers</th>
      <th>TARGET_outliers</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>100002</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>202500.0</td>
      <td>406597.5</td>
      <td>24700.5</td>
      <td>351000.0</td>
      <td>0.018801</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>异常值</td>
    </tr>
    <tr>
      <th>1</th>
      <td>100003</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>270000.0</td>
      <td>1293502.5</td>
      <td>35698.5</td>
      <td>1129500.0</td>
      <td>0.003541</td>
      <td>...</td>
      <td>异常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
    <tr>
      <th>2</th>
      <td>100004</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>67500.0</td>
      <td>135000.0</td>
      <td>6750.0</td>
      <td>135000.0</td>
      <td>0.010032</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
    <tr>
      <th>3</th>
      <td>100006</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>135000.0</td>
      <td>312682.5</td>
      <td>29686.5</td>
      <td>297000.0</td>
      <td>0.008019</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
    <tr>
      <th>4</th>
      <td>100007</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>121500.0</td>
      <td>513000.0</td>
      <td>21865.5</td>
      <td>513000.0</td>
      <td>0.028663</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>307506</th>
      <td>456251</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>157500.0</td>
      <td>254700.0</td>
      <td>27558.0</td>
      <td>225000.0</td>
      <td>0.032561</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
    <tr>
      <th>307507</th>
      <td>456252</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>72000.0</td>
      <td>269550.0</td>
      <td>12001.5</td>
      <td>225000.0</td>
      <td>0.025164</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
    <tr>
      <th>307508</th>
      <td>456253</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>153000.0</td>
      <td>677664.0</td>
      <td>29979.0</td>
      <td>585000.0</td>
      <td>0.005002</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
    <tr>
      <th>307509</th>
      <td>456254</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>171000.0</td>
      <td>370107.0</td>
      <td>20205.0</td>
      <td>319500.0</td>
      <td>0.005313</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>异常值</td>
    </tr>
    <tr>
      <th>307510</th>
      <td>456255</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>157500.0</td>
      <td>675000.0</td>
      <td>49117.5</td>
      <td>675000.0</td>
      <td>0.046220</td>
      <td>...</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
      <td>正常值</td>
    </tr>
  </tbody>
</table>
<p>307511 rows × 480 columns</p>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正常值与异常值各自占比情况</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> fea <span class="keyword">in</span> numerical_fea:</span><br><span class="line"></span><br><span class="line">    radio = outlier_train[fea+<span class="string">&#x27;_outliers&#x27;</span>].value_counts(<span class="string">&#x27;异常值&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(radio)</span><br></pre></td></tr></table></figure>

<pre><code>正常值    1.0
Name: SK_ID_CURR_outliers, dtype: float64
正常值    0.904787
异常值    0.095213
Name: NAME_CONTRACT_TYPE_outliers, dtype: float64
正常值    1.0
Name: FLAG_OWN_CAR_outliers, dtype: float64
正常值    1.0
Name: FLAG_OWN_REALTY_outliers, dtype: float64
正常值    0.986108
异常值    0.013892
Name: CNT_CHILDREN_outliers, dtype: float64
正常值    0.998524
异常值    0.001476
Name: AMT_INCOME_TOTAL_outliers, dtype: float64
正常值    0.989415
异常值    0.010585
Name: AMT_CREDIT_outliers, dtype: float64
正常值    0.990378
异常值    0.009622
Name: AMT_ANNUITY_outliers, dtype: float64
正常值    0.98643
异常值    0.01357
Name: AMT_GOODS_PRICE_outliers, dtype: float64
正常值    0.972645
异常值    0.027355
Name: REGION_POPULATION_RELATIVE_outliers, dtype: float64
正常值    1.0
Name: DAYS_BIRTH_outliers, dtype: float64
正常值    1.0
Name: DAYS_EMPLOYED_outliers, dtype: float64
正常值    0.997564
异常值    0.002436
Name: DAYS_REGISTRATION_outliers, dtype: float64
正常值    1.0
Name: DAYS_ID_PUBLISH_outliers, dtype: float64
正常值    0.989044
异常值    0.010956
Name: OWN_CAR_AGE_outliers, dtype: float64
正常值    0.999997
异常值    0.000003
Name: FLAG_MOBIL_outliers, dtype: float64
正常值    1.0
Name: FLAG_EMP_PHONE_outliers, dtype: float64
正常值    1.0
Name: FLAG_WORK_PHONE_outliers, dtype: float64
正常值    0.998133
异常值    0.001867
Name: FLAG_CONT_MOBILE_outliers, dtype: float64
正常值    1.0
Name: FLAG_PHONE_outliers, dtype: float64
正常值    0.94328
异常值    0.05672
Name: FLAG_EMAIL_outliers, dtype: float64
正常值    0.98697
异常值    0.01303
Name: CNT_FAM_MEMBERS_outliers, dtype: float64
正常值    1.0
Name: REGION_RATING_CLIENT_outliers, dtype: float64
正常值    1.0
Name: REGION_RATING_CLIENT_W_CITY_outliers, dtype: float64
正常值    0.997977
异常值    0.002023
Name: HOUR_APPR_PROCESS_START_outliers, dtype: float64
正常值    0.984856
异常值    0.015144
Name: REG_REGION_NOT_LIVE_REGION_outliers, dtype: float64
正常值    0.949231
异常值    0.050769
Name: REG_REGION_NOT_WORK_REGION_outliers, dtype: float64
正常值    0.959341
异常值    0.040659
Name: LIVE_REGION_NOT_WORK_REGION_outliers, dtype: float64
正常值    0.921827
异常值    0.078173
Name: REG_CITY_NOT_LIVE_CITY_outliers, dtype: float64
正常值    1.0
Name: REG_CITY_NOT_WORK_CITY_outliers, dtype: float64
正常值    1.0
Name: LIVE_CITY_NOT_WORK_CITY_outliers, dtype: float64
正常值    1.0
Name: EXT_SOURCE_1_outliers, dtype: float64
正常值    1.0
Name: EXT_SOURCE_2_outliers, dtype: float64
正常值    1.0
Name: EXT_SOURCE_3_outliers, dtype: float64
正常值    0.990303
异常值    0.009697
Name: APARTMENTS_AVG_outliers, dtype: float64
正常值    0.993584
异常值    0.006416
Name: BASEMENTAREA_AVG_outliers, dtype: float64
正常值    0.997743
异常值    0.002257
Name: YEARS_BEGINEXPLUATATION_AVG_outliers, dtype: float64
正常值    0.99612
异常值    0.00388
Name: YEARS_BUILD_AVG_outliers, dtype: float64
正常值    0.994455
异常值    0.005545
Name: COMMONAREA_AVG_outliers, dtype: float64
正常值    0.992065
异常值    0.007935
Name: ELEVATORS_AVG_outliers, dtype: float64
正常值    0.9928
异常值    0.0072
Name: ENTRANCES_AVG_outliers, dtype: float64
正常值    0.991509
异常值    0.008491
Name: FLOORSMAX_AVG_outliers, dtype: float64
正常值    0.998078
异常值    0.001922
Name: FLOORSMIN_AVG_outliers, dtype: float64
正常值    0.993207
异常值    0.006793
Name: LANDAREA_AVG_outliers, dtype: float64
正常值    0.994322
异常值    0.005678
Name: LIVINGAPARTMENTS_AVG_outliers, dtype: float64
正常值    0.989623
异常值    0.010377
Name: LIVINGAREA_AVG_outliers, dtype: float64
正常值    0.997652
异常值    0.002348
Name: NONLIVINGAPARTMENTS_AVG_outliers, dtype: float64
正常值    0.992156
异常值    0.007844
Name: NONLIVINGAREA_AVG_outliers, dtype: float64
正常值    0.990212
异常值    0.009788
Name: APARTMENTS_MODE_outliers, dtype: float64
正常值    0.993291
异常值    0.006709
Name: BASEMENTAREA_MODE_outliers, dtype: float64
正常值    0.997789
异常值    0.002211
Name: YEARS_BEGINEXPLUATATION_MODE_outliers, dtype: float64
正常值    0.996072
异常值    0.003928
Name: YEARS_BUILD_MODE_outliers, dtype: float64
正常值    0.994495
异常值    0.005505
Name: COMMONAREA_MODE_outliers, dtype: float64
正常值    0.98909
异常值    0.01091
Name: ELEVATORS_MODE_outliers, dtype: float64
正常值    0.991454
异常值    0.008546
Name: ENTRANCES_MODE_outliers, dtype: float64
正常值    0.991421
异常值    0.008579
Name: FLOORSMAX_MODE_outliers, dtype: float64
正常值    0.998439
异常值    0.001561
Name: FLOORSMIN_MODE_outliers, dtype: float64
正常值    0.993041
异常值    0.006959
Name: LANDAREA_MODE_outliers, dtype: float64
正常值    0.994124
异常值    0.005876
Name: LIVINGAPARTMENTS_MODE_outliers, dtype: float64
正常值    0.989126
异常值    0.010874
Name: LIVINGAREA_MODE_outliers, dtype: float64
正常值    0.997795
异常值    0.002205
Name: NONLIVINGAPARTMENTS_MODE_outliers, dtype: float64
正常值    0.991994
异常值    0.008006
Name: NONLIVINGAREA_MODE_outliers, dtype: float64
正常值    0.99013
异常值    0.00987
Name: APARTMENTS_MEDI_outliers, dtype: float64
正常值    0.993525
异常值    0.006475
Name: BASEMENTAREA_MEDI_outliers, dtype: float64
正常值    0.99788
异常值    0.00212
Name: YEARS_BEGINEXPLUATATION_MEDI_outliers, dtype: float64
正常值    0.996078
异常值    0.003922
Name: YEARS_BUILD_MEDI_outliers, dtype: float64
正常值    0.994397
异常值    0.005603
Name: COMMONAREA_MEDI_outliers, dtype: float64
正常值    0.992101
异常值    0.007899
Name: ELEVATORS_MEDI_outliers, dtype: float64
正常值    0.992761
异常值    0.007239
Name: ENTRANCES_MEDI_outliers, dtype: float64
正常值    0.991109
异常值    0.008891
Name: FLOORSMAX_MEDI_outliers, dtype: float64
正常值    0.998202
异常值    0.001798
Name: FLOORSMIN_MEDI_outliers, dtype: float64
正常值    0.993064
异常值    0.006936
Name: LANDAREA_MEDI_outliers, dtype: float64
正常值    0.994247
异常值    0.005753
Name: LIVINGAPARTMENTS_MEDI_outliers, dtype: float64
正常值    0.989513
异常值    0.010487
Name: LIVINGAREA_MEDI_outliers, dtype: float64
正常值    0.997659
异常值    0.002341
Name: NONLIVINGAPARTMENTS_MEDI_outliers, dtype: float64
正常值    0.992091
异常值    0.007909
Name: NONLIVINGAREA_MEDI_outliers, dtype: float64
正常值    0.989194
异常值    0.010806
Name: TOTALAREA_MODE_outliers, dtype: float64
正常值    0.979965
异常值    0.020035
Name: OBS_30_CNT_SOCIAL_CIRCLE_outliers, dtype: float64
正常值    0.977763
异常值    0.022237
Name: DEF_30_CNT_SOCIAL_CIRCLE_outliers, dtype: float64
正常值    0.980537
异常值    0.019463
Name: OBS_60_CNT_SOCIAL_CIRCLE_outliers, dtype: float64
正常值    0.987226
异常值    0.012774
Name: DEF_60_CNT_SOCIAL_CIRCLE_outliers, dtype: float64
正常值    0.997919
异常值    0.002081
Name: DAYS_LAST_PHONE_CHANGE_outliers, dtype: float64
正常值    0.999958
异常值    0.000042
Name: FLAG_DOCUMENT_2_outliers, dtype: float64
正常值    1.0
Name: FLAG_DOCUMENT_3_outliers, dtype: float64
正常值    0.999919
异常值    0.000081
Name: FLAG_DOCUMENT_4_outliers, dtype: float64
正常值    0.984885
异常值    0.015115
Name: FLAG_DOCUMENT_5_outliers, dtype: float64
正常值    0.911945
异常值    0.088055
Name: FLAG_DOCUMENT_6_outliers, dtype: float64
正常值    0.999808
异常值    0.000192
Name: FLAG_DOCUMENT_7_outliers, dtype: float64
正常值    0.918624
异常值    0.081376
Name: FLAG_DOCUMENT_8_outliers, dtype: float64
正常值    0.996104
异常值    0.003896
Name: FLAG_DOCUMENT_9_outliers, dtype: float64
正常值    0.999977
异常值    0.000023
Name: FLAG_DOCUMENT_10_outliers, dtype: float64
正常值    0.996088
异常值    0.003912
Name: FLAG_DOCUMENT_11_outliers, dtype: float64
正常值    0.999993
异常值    0.000007
Name: FLAG_DOCUMENT_12_outliers, dtype: float64
正常值    0.996475
异常值    0.003525
Name: FLAG_DOCUMENT_13_outliers, dtype: float64
正常值    0.997064
异常值    0.002936
Name: FLAG_DOCUMENT_14_outliers, dtype: float64
正常值    0.99879
异常值    0.00121
Name: FLAG_DOCUMENT_15_outliers, dtype: float64
正常值    0.990072
异常值    0.009928
Name: FLAG_DOCUMENT_16_outliers, dtype: float64
正常值    0.999733
异常值    0.000267
Name: FLAG_DOCUMENT_17_outliers, dtype: float64
正常值    0.99187
异常值    0.00813
Name: FLAG_DOCUMENT_18_outliers, dtype: float64
正常值    0.999405
异常值    0.000595
Name: FLAG_DOCUMENT_19_outliers, dtype: float64
正常值    0.999493
异常值    0.000507
Name: FLAG_DOCUMENT_20_outliers, dtype: float64
正常值    0.999665
异常值    0.000335
Name: FLAG_DOCUMENT_21_outliers, dtype: float64
正常值    0.994712
异常值    0.005288
Name: AMT_REQ_CREDIT_BUREAU_HOUR_outliers, dtype: float64
正常值    0.995158
异常值    0.004842
Name: AMT_REQ_CREDIT_BUREAU_DAY_outliers, dtype: float64
正常值    0.972242
异常值    0.027758
Name: AMT_REQ_CREDIT_BUREAU_WEEK_outliers, dtype: float64
正常值    0.98948
异常值    0.01052
Name: AMT_REQ_CREDIT_BUREAU_MON_outliers, dtype: float64
正常值    0.992517
异常值    0.007483
Name: AMT_REQ_CREDIT_BUREAU_QRT_outliers, dtype: float64
正常值    0.989061
异常值    0.010939
Name: AMT_REQ_CREDIT_BUREAU_YEAR_outliers, dtype: float64
正常值    1.0
Name: CODE_GENDER_F_outliers, dtype: float64
正常值    1.0
Name: CODE_GENDER_M_outliers, dtype: float64
正常值    0.989376
异常值    0.010624
Name: NAME_TYPE_SUITE_Children_outliers, dtype: float64
正常值    1.0
Name: NAME_TYPE_SUITE_Family_outliers, dtype: float64
正常值    0.999119
异常值    0.000881
Name: NAME_TYPE_SUITE_Group of people_outliers, dtype: float64
正常值    0.997184
异常值    0.002816
Name: NAME_TYPE_SUITE_Other_A_outliers, dtype: float64
正常值    0.994244
异常值    0.005756
Name: NAME_TYPE_SUITE_Other_B_outliers, dtype: float64
正常值    0.963026
异常值    0.036974
Name: NAME_TYPE_SUITE_Spouse, partner_outliers, dtype: float64
正常值    1.0
Name: NAME_TYPE_SUITE_Unaccompanied_outliers, dtype: float64
正常值    0.999967
异常值    0.000033
Name: NAME_INCOME_TYPE_Businessman_outliers, dtype: float64
正常值    1.0
Name: NAME_INCOME_TYPE_Commercial associate_outliers, dtype: float64
正常值    1.0
Name: NAME_INCOME_TYPE_Pensioner_outliers, dtype: float64
正常值    0.929424
异常值    0.070576
Name: NAME_INCOME_TYPE_State servant_outliers, dtype: float64
正常值    0.999941
异常值    0.000059
Name: NAME_INCOME_TYPE_Student_outliers, dtype: float64
正常值    0.999928
异常值    0.000072
Name: NAME_INCOME_TYPE_Unemployed_outliers, dtype: float64
正常值    1.0
Name: NAME_INCOME_TYPE_Working_outliers, dtype: float64
正常值    0.999467
异常值    0.000533
Name: NAME_EDUCATION_TYPE_Academic degree_outliers, dtype: float64
正常值    1.0
Name: NAME_EDUCATION_TYPE_Higher education_outliers, dtype: float64
正常值    0.96658
异常值    0.03342
Name: NAME_EDUCATION_TYPE_Incomplete higher_outliers, dtype: float64
正常值    0.987591
异常值    0.012409
Name: NAME_EDUCATION_TYPE_Lower secondary_outliers, dtype: float64
正常值    1.0
Name: NAME_EDUCATION_TYPE_Secondary / secondary special_outliers, dtype: float64
正常值    0.903174
异常值    0.096826
Name: NAME_FAMILY_STATUS_Civil marriage_outliers, dtype: float64
正常值    1.0
Name: NAME_FAMILY_STATUS_Married_outliers, dtype: float64
正常值    0.93571
异常值    0.06429
Name: NAME_FAMILY_STATUS_Separated_outliers, dtype: float64
正常值    1.0
Name: NAME_FAMILY_STATUS_Single / not married_outliers, dtype: float64
正常值    0.947683
异常值    0.052317
Name: NAME_FAMILY_STATUS_Widow_outliers, dtype: float64
正常值    0.996351
异常值    0.003649
Name: NAME_HOUSING_TYPE_Co-op apartment_outliers, dtype: float64
正常值    1.0
Name: NAME_HOUSING_TYPE_House / apartment_outliers, dtype: float64
正常值    0.963634
异常值    0.036366
Name: NAME_HOUSING_TYPE_Municipal apartment_outliers, dtype: float64
正常值    0.99149
异常值    0.00851
Name: NAME_HOUSING_TYPE_Office apartment_outliers, dtype: float64
正常值    0.984127
异常值    0.015873
Name: NAME_HOUSING_TYPE_Rented apartment_outliers, dtype: float64
正常值    0.951742
异常值    0.048258
Name: NAME_HOUSING_TYPE_With parents_outliers, dtype: float64
正常值    0.968089
异常值    0.031911
Name: OCCUPATION_TYPE_Accountants_outliers, dtype: float64
正常值    0.984869
异常值    0.015131
Name: OCCUPATION_TYPE_Cleaning staff_outliers, dtype: float64
正常值    0.980664
异常值    0.019336
Name: OCCUPATION_TYPE_Cooking staff_outliers, dtype: float64
正常值    0.910345
异常值    0.089655
Name: OCCUPATION_TYPE_Core staff_outliers, dtype: float64
正常值    0.939505
异常值    0.060495
Name: OCCUPATION_TYPE_Drivers_outliers, dtype: float64
正常值    0.998169
异常值    0.001831
Name: OCCUPATION_TYPE_HR staff_outliers, dtype: float64
正常值    0.962993
异常值    0.037007
Name: OCCUPATION_TYPE_High skill tech staff_outliers, dtype: float64
正常值    0.998289
异常值    0.001711
Name: OCCUPATION_TYPE_IT staff_outliers, dtype: float64
正常值    1.0
Name: OCCUPATION_TYPE_Laborers_outliers, dtype: float64
正常值    0.993194
异常值    0.006806
Name: OCCUPATION_TYPE_Low-skill Laborers_outliers, dtype: float64
正常值    0.930503
异常值    0.069497
Name: OCCUPATION_TYPE_Managers_outliers, dtype: float64
正常值    0.972238
异常值    0.027762
Name: OCCUPATION_TYPE_Medicine staff_outliers, dtype: float64
正常值    0.991376
异常值    0.008624
Name: OCCUPATION_TYPE_Private service staff_outliers, dtype: float64
正常值    0.997558
异常值    0.002442
Name: OCCUPATION_TYPE_Realty agents_outliers, dtype: float64
正常值    1.0
Name: OCCUPATION_TYPE_Sales staff_outliers, dtype: float64
正常值    0.995756
异常值    0.004244
Name: OCCUPATION_TYPE_Secretaries_outliers, dtype: float64
正常值    0.978144
异常值    0.021856
Name: OCCUPATION_TYPE_Security staff_outliers, dtype: float64
正常值    0.995616
异常值    0.004384
Name: OCCUPATION_TYPE_Waiters/barmen staff_outliers, dtype: float64
正常值    1.0
Name: WEEKDAY_APPR_PROCESS_START_FRIDAY_outliers, dtype: float64
正常值    1.0
Name: WEEKDAY_APPR_PROCESS_START_MONDAY_outliers, dtype: float64
正常值    1.0
Name: WEEKDAY_APPR_PROCESS_START_SATURDAY_outliers, dtype: float64
正常值    0.947381
异常值    0.052619
Name: WEEKDAY_APPR_PROCESS_START_SUNDAY_outliers, dtype: float64
正常值    1.0
Name: WEEKDAY_APPR_PROCESS_START_THURSDAY_outliers, dtype: float64
正常值    1.0
Name: WEEKDAY_APPR_PROCESS_START_TUESDAY_outliers, dtype: float64
正常值    1.0
Name: WEEKDAY_APPR_PROCESS_START_WEDNESDAY_outliers, dtype: float64
正常值    0.998605
异常值    0.001395
Name: ORGANIZATION_TYPE_Advertising_outliers, dtype: float64
正常值    0.99202
异常值    0.00798
Name: ORGANIZATION_TYPE_Agriculture_outliers, dtype: float64
正常值    0.991847
异常值    0.008153
Name: ORGANIZATION_TYPE_Bank_outliers, dtype: float64
正常值    0.980541
异常值    0.019459
Name: ORGANIZATION_TYPE_Business Entity Type 1_outliers, dtype: float64
正常值    0.965683
异常值    0.034317
Name: ORGANIZATION_TYPE_Business Entity Type 2_outliers, dtype: float64
正常值    1.0
Name: ORGANIZATION_TYPE_Business Entity Type 3_outliers, dtype: float64
正常值    0.999155
异常值    0.000845
Name: ORGANIZATION_TYPE_Cleaning_outliers, dtype: float64
正常值    0.978144
异常值    0.021856
Name: ORGANIZATION_TYPE_Construction_outliers, dtype: float64
正常值    0.998768
异常值    0.001232
Name: ORGANIZATION_TYPE_Culture_outliers, dtype: float64
正常值    0.996911
异常值    0.003089
Name: ORGANIZATION_TYPE_Electricity_outliers, dtype: float64
正常值    0.998179
异常值    0.001821
Name: ORGANIZATION_TYPE_Emergency_outliers, dtype: float64
正常值    0.966167
异常值    0.033833
Name: ORGANIZATION_TYPE_Government_outliers, dtype: float64
正常值    0.996859
异常值    0.003141
Name: ORGANIZATION_TYPE_Hotel_outliers, dtype: float64
正常值    0.990381
异常值    0.009619
Name: ORGANIZATION_TYPE_Housing_outliers, dtype: float64
正常值    0.996621
异常值    0.003379
Name: ORGANIZATION_TYPE_Industry: type 1_outliers, dtype: float64
正常值    0.999646
异常值    0.000354
Name: ORGANIZATION_TYPE_Industry: type 10_outliers, dtype: float64
正常值    0.991207
异常值    0.008793
Name: ORGANIZATION_TYPE_Industry: type 11_outliers, dtype: float64
正常值    0.9988
异常值    0.0012
Name: ORGANIZATION_TYPE_Industry: type 12_outliers, dtype: float64
正常值    0.999782
异常值    0.000218
Name: ORGANIZATION_TYPE_Industry: type 13_outliers, dtype: float64
正常值    0.998511
异常值    0.001489
Name: ORGANIZATION_TYPE_Industry: type 2_outliers, dtype: float64
正常值    0.98934
异常值    0.01066
Name: ORGANIZATION_TYPE_Industry: type 3_outliers, dtype: float64
正常值    0.997148
异常值    0.002852
Name: ORGANIZATION_TYPE_Industry: type 4_outliers, dtype: float64
正常值    0.998052
异常值    0.001948
Name: ORGANIZATION_TYPE_Industry: type 5_outliers, dtype: float64
正常值    0.999636
异常值    0.000364
Name: ORGANIZATION_TYPE_Industry: type 6_outliers, dtype: float64
正常值    0.99575
异常值    0.00425
Name: ORGANIZATION_TYPE_Industry: type 7_outliers, dtype: float64
正常值    0.999922
异常值    0.000078
Name: ORGANIZATION_TYPE_Industry: type 8_outliers, dtype: float64
正常值    0.989048
异常值    0.010952
Name: ORGANIZATION_TYPE_Industry: type 9_outliers, dtype: float64
正常值    0.998059
异常值    0.001941
Name: ORGANIZATION_TYPE_Insurance_outliers, dtype: float64
正常值    0.977627
异常值    0.022373
Name: ORGANIZATION_TYPE_Kindergarten_outliers, dtype: float64
正常值    0.999008
异常值    0.000992
Name: ORGANIZATION_TYPE_Legal Services_outliers, dtype: float64
正常值    0.963601
异常值    0.036399
Name: ORGANIZATION_TYPE_Medicine_outliers, dtype: float64
正常值    0.991434
异常值    0.008566
Name: ORGANIZATION_TYPE_Military_outliers, dtype: float64
正常值    0.998969
异常值    0.001031
Name: ORGANIZATION_TYPE_Mobile_outliers, dtype: float64
正常值    0.945748
异常值    0.054252
Name: ORGANIZATION_TYPE_Other_outliers, dtype: float64
正常值    0.992387
异常值    0.007613
Name: ORGANIZATION_TYPE_Police_outliers, dtype: float64
正常值    0.992986
异常值    0.007014
Name: ORGANIZATION_TYPE_Postal_outliers, dtype: float64
正常值    0.998712
异常值    0.001288
Name: ORGANIZATION_TYPE_Realtor_outliers, dtype: float64
正常值    0.999724
异常值    0.000276
Name: ORGANIZATION_TYPE_Religion_outliers, dtype: float64
正常值    0.994111
异常值    0.005889
Name: ORGANIZATION_TYPE_Restaurant_outliers, dtype: float64
正常值    0.971081
异常值    0.028919
Name: ORGANIZATION_TYPE_School_outliers, dtype: float64
正常值    0.989441
异常值    0.010559
Name: ORGANIZATION_TYPE_Security_outliers, dtype: float64
正常值    0.993581
异常值    0.006419
Name: ORGANIZATION_TYPE_Security Ministries_outliers, dtype: float64
正常值    1.0
Name: ORGANIZATION_TYPE_Self-employed_outliers, dtype: float64
正常值    0.994878
异常值    0.005122
Name: ORGANIZATION_TYPE_Services_outliers, dtype: float64
正常值    0.998124
异常值    0.001876
Name: ORGANIZATION_TYPE_Telecom_outliers, dtype: float64
正常值    0.998868
异常值    0.001132
Name: ORGANIZATION_TYPE_Trade: type 1_outliers, dtype: float64
正常值    0.993821
异常值    0.006179
Name: ORGANIZATION_TYPE_Trade: type 2_outliers, dtype: float64
正常值    0.988644
异常值    0.011356
Name: ORGANIZATION_TYPE_Trade: type 3_outliers, dtype: float64
正常值    0.999792
异常值    0.000208
Name: ORGANIZATION_TYPE_Trade: type 4_outliers, dtype: float64
正常值    0.999841
异常值    0.000159
Name: ORGANIZATION_TYPE_Trade: type 5_outliers, dtype: float64
正常值    0.997948
异常值    0.002052
Name: ORGANIZATION_TYPE_Trade: type 6_outliers, dtype: float64
正常值    0.974534
异常值    0.025466
Name: ORGANIZATION_TYPE_Trade: type 7_outliers, dtype: float64
正常值    0.999346
异常值    0.000654
Name: ORGANIZATION_TYPE_Transport: type 1_outliers, dtype: float64
正常值    0.992833
异常值    0.007167
Name: ORGANIZATION_TYPE_Transport: type 2_outliers, dtype: float64
正常值    0.99614
异常值    0.00386
Name: ORGANIZATION_TYPE_Transport: type 3_outliers, dtype: float64
正常值    0.982446
异常值    0.017554
Name: ORGANIZATION_TYPE_Transport: type 4_outliers, dtype: float64
正常值    0.995685
异常值    0.004315
Name: ORGANIZATION_TYPE_University_outliers, dtype: float64
正常值    1.0
Name: ORGANIZATION_TYPE_XNA_outliers, dtype: float64
正常值    0.981506
异常值    0.018494
Name: FONDKAPREMONT_MODE_not specified_outliers, dtype: float64
正常值    0.981727
异常值    0.018273
Name: FONDKAPREMONT_MODE_org spec account_outliers, dtype: float64
正常值    1.0
Name: FONDKAPREMONT_MODE_reg oper account_outliers, dtype: float64
正常值    0.960717
异常值    0.039283
Name: FONDKAPREMONT_MODE_reg oper spec account_outliers, dtype: float64
正常值    1.0
Name: HOUSETYPE_MODE_block of flats_outliers, dtype: float64
正常值    0.995125
异常值    0.004875
Name: HOUSETYPE_MODE_specific housing_outliers, dtype: float64
正常值    0.996059
异常值    0.003941
Name: HOUSETYPE_MODE_terraced house_outliers, dtype: float64
正常值    0.96991
异常值    0.03009
Name: WALLSMATERIAL_MODE_Block_outliers, dtype: float64
正常值    0.992534
异常值    0.007466
Name: WALLSMATERIAL_MODE_Mixed_outliers, dtype: float64
正常值    0.994215
异常值    0.005785
Name: WALLSMATERIAL_MODE_Monolithic_outliers, dtype: float64
正常值    0.994716
异常值    0.005284
Name: WALLSMATERIAL_MODE_Others_outliers, dtype: float64
正常值    1.0
Name: WALLSMATERIAL_MODE_Panel_outliers, dtype: float64
正常值    1.0
Name: WALLSMATERIAL_MODE_Stone, brick_outliers, dtype: float64
正常值    0.982563
异常值    0.017437
Name: WALLSMATERIAL_MODE_Wooden_outliers, dtype: float64
正常值    1.0
Name: EMERGENCYSTATE_MODE_No_outliers, dtype: float64
正常值    0.99243
异常值    0.00757
Name: EMERGENCYSTATE_MODE_Yes_outliers, dtype: float64
正常值    0.919271
异常值    0.080729
Name: TARGET_outliers, dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查异常值，利用描述统计describe查看特征的均值极大值极小值等结合常识和业务判断是否存在异常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户年龄分布，此处该特征为负数，反映的是申请贷款前用户存活天数故除以-365得到年龄</span></span><br><span class="line"></span><br><span class="line">(app_train[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>] / -<span class="number">365</span>).describe()</span><br></pre></td></tr></table></figure>




<pre><code>count    307511.000000
mean         43.936973
std          11.956133
min          20.517808
25%          34.008219
50%          43.150685
75%          53.923288
max          69.120548
Name: DAYS_BIRTH, dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看工作年限，此处结果最小值为-1000年明显异常</span></span><br><span class="line"></span><br><span class="line">(app_train[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>] / -<span class="number">365</span>).describe()</span><br></pre></td></tr></table></figure>




<pre><code>count    307511.000000
mean       -174.835742
std         387.056895
min       -1000.665753
25%           0.791781
50%           3.323288
75%           7.561644
max          49.073973
Name: DAYS_EMPLOYED, dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 经查看天数在数据集中均表示为负数，365243可能为替代缺失值的数字</span></span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>].plot.hist(title = <span class="string">&#x27;Days Employment Histogram&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Days Employment&#x27;</span>)</span><br></pre></td></tr></table></figure>




<pre><code>Text(0.5, 0, &#39;Days Employment&#39;)
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqvOt1"><img src="https://z3.ax1x.com/2021/08/19/fqvOt1.png" alt="fqvOt1.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看异常数据的违约率是否比其他的数据高，可以看到异常值违约率更低</span></span><br><span class="line"></span><br><span class="line">anom = app_train[app_train[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>] == <span class="number">365243</span>]</span><br><span class="line"></span><br><span class="line">non_anom = app_train[app_train[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>] != <span class="number">365243</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;The non-anomalies default on %0.2f%% of loans&#x27;</span> % (<span class="number">100</span> * non_anom[<span class="string">&#x27;TARGET&#x27;</span>].mean()))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;The anomalies default on %0.2f%% of loans&#x27;</span> % (<span class="number">100</span> * anom[<span class="string">&#x27;TARGET&#x27;</span>].mean()))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;There are %d anomalous days of employment&#x27;</span> % <span class="built_in">len</span>(anom))</span><br></pre></td></tr></table></figure>

<pre><code>The non-anomalies default on 8.66% of loans
The anomalies default on 5.40% of loans
There are 55374 anomalous days of employment
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新列表示该数据是否异常</span></span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;DAYS_EMPLOYED_ANOM&#x27;</span>] = app_train[<span class="string">&quot;DAYS_EMPLOYED&quot;</span>] == <span class="number">365243</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用缺失值替换空值标志</span></span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>].replace(&#123;<span class="number">365243</span>: np.nan&#125;, inplace = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>].plot.hist(title = <span class="string">&#x27;Days Employment Histogram&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Days Employment&#x27;</span>)</span><br></pre></td></tr></table></figure>




<pre><code>Text(0.5, 0, &#39;Days Employment&#39;)
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqvLkR"><img src="https://z3.ax1x.com/2021/08/19/fqvLkR.png" alt="fqvLkR.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对测试集做相同操作</span></span><br><span class="line"></span><br><span class="line">app_test[<span class="string">&#x27;DAYS_EMPLOYED_ANOM&#x27;</span>] = app_test[<span class="string">&quot;DAYS_EMPLOYED&quot;</span>] == <span class="number">365243</span></span><br><span class="line"></span><br><span class="line">app_test[<span class="string">&quot;DAYS_EMPLOYED&quot;</span>].replace(&#123;<span class="number">365243</span>: np.nan&#125;, inplace = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;There are %d anomalies in the test data out of %d entries&#x27;</span> % (app_test[<span class="string">&quot;DAYS_EMPLOYED_ANOM&quot;</span>].<span class="built_in">sum</span>(), <span class="built_in">len</span>(app_test)))</span><br></pre></td></tr></table></figure>

<pre><code>There are 9274 anomalies in the test data out of 48744 entries
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看特征与标签的相关性，并排序</span></span><br><span class="line"></span><br><span class="line">correlations = app_train.corr()[<span class="string">&#x27;TARGET&#x27;</span>].sort_values()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Most Positive Correlations:\n&#x27;</span>, correlations.tail(<span class="number">15</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\nMost Negative Correlations:\n&#x27;</span>, correlations.head(<span class="number">15</span>))</span><br></pre></td></tr></table></figure>

<pre><code>Most Positive Correlations:
 OCCUPATION_TYPE_Laborers                             0.043019
FLAG_DOCUMENT_3                                      0.044346
REG_CITY_NOT_LIVE_CITY                               0.044395
FLAG_EMP_PHONE                                       0.045982
NAME_EDUCATION_TYPE_Secondary / secondary special    0.049824
REG_CITY_NOT_WORK_CITY                               0.050994
DAYS_ID_PUBLISH                                      0.051457
CODE_GENDER_M                                        0.054713
DAYS_LAST_PHONE_CHANGE                               0.055218
NAME_INCOME_TYPE_Working                             0.057481
REGION_RATING_CLIENT                                 0.058899
REGION_RATING_CLIENT_W_CITY                          0.060893
DAYS_EMPLOYED                                        0.074958
DAYS_BIRTH                                           0.078239
TARGET                                               1.000000
Name: TARGET, dtype: float64

Most Negative Correlations:
 EXT_SOURCE_3                           -0.178919
EXT_SOURCE_2                           -0.160472
EXT_SOURCE_1                           -0.155317
NAME_EDUCATION_TYPE_Higher education   -0.056593
CODE_GENDER_F                          -0.054704
NAME_INCOME_TYPE_Pensioner             -0.046209
DAYS_EMPLOYED_ANOM                     -0.045987
ORGANIZATION_TYPE_XNA                  -0.045987
FLOORSMAX_AVG                          -0.044003
FLOORSMAX_MEDI                         -0.043768
FLOORSMAX_MODE                         -0.043226
EMERGENCYSTATE_MODE_No                 -0.042201
HOUSETYPE_MODE_block of flats          -0.040594
AMT_GOODS_PRICE                        -0.039645
REGION_POPULATION_RELATIVE             -0.037227
Name: TARGET, dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 年龄特征天数在源数据中是负的，年龄越大应越不容易违约，在此处对该数据上了绝对值重新计算相关性</span></span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>] = <span class="built_in">abs</span>(app_train[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>])</span><br><span class="line"></span><br><span class="line">app_train[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>].corr(app_train[<span class="string">&#x27;TARGET&#x27;</span>])</span><br></pre></td></tr></table></figure>




<pre><code>-0.07823930830982712
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置图形样式</span></span><br><span class="line"></span><br><span class="line">plt.style.use(<span class="string">&#x27;fivethirtyeight&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对客户年龄分布进行作图</span></span><br><span class="line"></span><br><span class="line">plt.hist(app_train[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>] / <span class="number">365</span>, edgecolor = <span class="string">&#x27;k&#x27;</span>, bins = <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;Age of Client&#x27;</span>); plt.xlabel(<span class="string">&#x27;Age (years)&#x27;</span>); plt.ylabel(<span class="string">&#x27;Count&#x27;</span>)</span><br></pre></td></tr></table></figure>




<pre><code>Text(0, 0.5, &#39;Count&#39;)
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqvx1K"><img src="https://z3.ax1x.com/2021/08/19/fqvx1K.png" alt="fqvx1K.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize = (<span class="number">10</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 未违约用户年龄的KDE图</span></span><br><span class="line"></span><br><span class="line">sns.kdeplot(data = app_train.loc[app_train[<span class="string">&#x27;TARGET&#x27;</span>] == <span class="number">0</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>] / <span class="number">365</span>, label = <span class="string">&#x27;target == 0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 违约用户年龄的KDE图</span></span><br><span class="line"></span><br><span class="line">sns.kdeplot(data = app_train.loc[app_train[<span class="string">&#x27;TARGET&#x27;</span>] == <span class="number">1</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>] / <span class="number">365</span>, label = <span class="string">&#x27;target == 1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 坐标轴</span></span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Age (years)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.ylabel(<span class="string">&#x27;Density&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;Distribution of Ages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.legend()    <span class="comment"># 重要，没有显示标签语句，原图设置了标签但不显示</span></span><br></pre></td></tr></table></figure>




<pre><code>&lt;matplotlib.legend.Legend at 0x158876e93c8&gt;
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqvvp6"><img src="https://z3.ax1x.com/2021/08/19/fqvvp6.png" alt="fqvvp6.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对年龄进行分箱</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将年龄数据取出</span></span><br><span class="line"></span><br><span class="line">age_data = app_train[[<span class="string">&#x27;TARGET&#x27;</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">age_data[<span class="string">&#x27;YEARS_BIRTH&#x27;</span>] = age_data[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>] / <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将年龄数据分箱，利用np.linspace在20-70之间生成11个数来划分区间</span></span><br><span class="line"></span><br><span class="line">age_data[<span class="string">&#x27;YEARS_BINNED&#x27;</span>] = pd.cut(age_data[<span class="string">&#x27;YEARS_BIRTH&#x27;</span>], bins = np.linspace(<span class="number">20</span>, <span class="number">70</span>, num = <span class="number">11</span>))</span><br><span class="line"></span><br><span class="line">age_data.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TARGET</th>
      <th>DAYS_BIRTH</th>
      <th>YEARS_BIRTH</th>
      <th>YEARS_BINNED</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>9461</td>
      <td>25.920548</td>
      <td>(25.0, 30.0]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>16765</td>
      <td>45.931507</td>
      <td>(45.0, 50.0]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>19046</td>
      <td>52.180822</td>
      <td>(50.0, 55.0]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>19005</td>
      <td>52.068493</td>
      <td>(50.0, 55.0]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>19932</td>
      <td>54.608219</td>
      <td>(50.0, 55.0]</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>16941</td>
      <td>46.413699</td>
      <td>(45.0, 50.0]</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0</td>
      <td>13778</td>
      <td>37.747945</td>
      <td>(35.0, 40.0]</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>18850</td>
      <td>51.643836</td>
      <td>(50.0, 55.0]</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0</td>
      <td>20099</td>
      <td>55.065753</td>
      <td>(55.0, 60.0]</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0</td>
      <td>14469</td>
      <td>39.641096</td>
      <td>(35.0, 40.0]</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据分箱进行分组并求均值</span></span><br><span class="line"></span><br><span class="line">age_groups  = age_data.groupby(<span class="string">&#x27;YEARS_BINNED&#x27;</span>).mean()</span><br><span class="line"></span><br><span class="line">age_groups</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TARGET</th>
      <th>DAYS_BIRTH</th>
      <th>YEARS_BIRTH</th>
    </tr>
    <tr>
      <th>YEARS_BINNED</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(20.0, 25.0]</th>
      <td>0.123036</td>
      <td>8532.795625</td>
      <td>23.377522</td>
    </tr>
    <tr>
      <th>(25.0, 30.0]</th>
      <td>0.111436</td>
      <td>10155.219250</td>
      <td>27.822518</td>
    </tr>
    <tr>
      <th>(30.0, 35.0]</th>
      <td>0.102814</td>
      <td>11854.848377</td>
      <td>32.479037</td>
    </tr>
    <tr>
      <th>(35.0, 40.0]</th>
      <td>0.089414</td>
      <td>13707.908253</td>
      <td>37.555913</td>
    </tr>
    <tr>
      <th>(40.0, 45.0]</th>
      <td>0.078491</td>
      <td>15497.661233</td>
      <td>42.459346</td>
    </tr>
    <tr>
      <th>(45.0, 50.0]</th>
      <td>0.074171</td>
      <td>17323.900441</td>
      <td>47.462741</td>
    </tr>
    <tr>
      <th>(50.0, 55.0]</th>
      <td>0.066968</td>
      <td>19196.494791</td>
      <td>52.593136</td>
    </tr>
    <tr>
      <th>(55.0, 60.0]</th>
      <td>0.055314</td>
      <td>20984.262742</td>
      <td>57.491131</td>
    </tr>
    <tr>
      <th>(60.0, 65.0]</th>
      <td>0.052737</td>
      <td>22780.547460</td>
      <td>62.412459</td>
    </tr>
    <tr>
      <th>(65.0, 70.0]</th>
      <td>0.037270</td>
      <td>24292.614340</td>
      <td>66.555108</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize = (<span class="number">8</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将年龄分箱和平均违约率作条形图</span></span><br><span class="line"></span><br><span class="line">plt.bar(age_groups.index.astype(<span class="built_in">str</span>), <span class="number">100</span> * age_groups[<span class="string">&#x27;TARGET&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 坐标轴</span></span><br><span class="line"></span><br><span class="line">plt.xticks(rotation = <span class="number">75</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Age Group (years)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.ylabel(<span class="string">&#x27;Failure to Repay (%)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;Failure to Repay by Age Group&#x27;</span>)</span><br></pre></td></tr></table></figure>




<pre><code>Text(0.5, 1.0, &#39;Failure to Repay by Age Group&#39;)
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqvz6O"><img src="https://z3.ax1x.com/2021/08/19/fqvz6O.png" alt="fqvz6O.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查三个与目标负相关最强的变量彼此之间和与目标等属性间的相关性</span></span><br><span class="line"></span><br><span class="line">ext_data = app_train[[<span class="string">&#x27;TARGET&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_1&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_2&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_3&#x27;</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">ext_data_corrs = ext_data.corr()</span><br><span class="line"></span><br><span class="line">ext_data_corrs</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TARGET</th>
      <th>EXT_SOURCE_1</th>
      <th>EXT_SOURCE_2</th>
      <th>EXT_SOURCE_3</th>
      <th>DAYS_BIRTH</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>TARGET</th>
      <td>1.000000</td>
      <td>-0.155317</td>
      <td>-0.160472</td>
      <td>-0.178919</td>
      <td>-0.078239</td>
    </tr>
    <tr>
      <th>EXT_SOURCE_1</th>
      <td>-0.155317</td>
      <td>1.000000</td>
      <td>0.213982</td>
      <td>0.186846</td>
      <td>0.600610</td>
    </tr>
    <tr>
      <th>EXT_SOURCE_2</th>
      <td>-0.160472</td>
      <td>0.213982</td>
      <td>1.000000</td>
      <td>0.109167</td>
      <td>0.091996</td>
    </tr>
    <tr>
      <th>EXT_SOURCE_3</th>
      <td>-0.178919</td>
      <td>0.186846</td>
      <td>0.109167</td>
      <td>1.000000</td>
      <td>0.205478</td>
    </tr>
    <tr>
      <th>DAYS_BIRTH</th>
      <td>-0.078239</td>
      <td>0.600610</td>
      <td>0.091996</td>
      <td>0.205478</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize = (<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对相关性作热度图 annot=True格子上显示数字 vmin\vmax确定颜色范围</span></span><br><span class="line"></span><br><span class="line">sns.heatmap(ext_data_corrs, cmap = plt.cm.RdYlBu_r, vmin = -<span class="number">0.25</span>, annot = <span class="literal">True</span>, vmax = <span class="number">0.6</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;Correlation Heatmap&#x27;</span>)</span><br></pre></td></tr></table></figure>




<pre><code>Text(0.5, 1.0, &#39;Correlation Heatmap&#39;)
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqxSXD"><img src="https://z3.ax1x.com/2021/08/19/fqxSXD.png" alt="fqxSXD.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize = (<span class="number">10</span>, <span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历三个变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, source <span class="keyword">in</span> <span class="built_in">enumerate</span>([<span class="string">&#x27;EXT_SOURCE_1&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_2&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_3&#x27;</span>]):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># subplot三个整数是子图行数、列数和索引值</span></span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">3</span>, <span class="number">1</span>, i + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 未违约客户KDE图</span></span><br><span class="line"></span><br><span class="line">    sns.kdeplot(app_train.loc[app_train[<span class="string">&#x27;TARGET&#x27;</span>] == <span class="number">0</span>, source], label = <span class="string">&#x27;target == 0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 违约客户KDE图</span></span><br><span class="line"></span><br><span class="line">    sns.kdeplot(app_train.loc[app_train[<span class="string">&#x27;TARGET&#x27;</span>] == <span class="number">1</span>, source], label = <span class="string">&#x27;target == 1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 坐标轴</span></span><br><span class="line"></span><br><span class="line">    plt.title(<span class="string">&#x27;Distribution of %s by Target Value&#x27;</span> % source)</span><br><span class="line"></span><br><span class="line">    plt.xlabel(<span class="string">&#x27;%s&#x27;</span> % source); plt.ylabel(<span class="string">&#x27;Density&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    plt.legend()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">plt.tight_layout(h_pad = <span class="number">2.5</span>)</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqx9ne"><img src="https://z3.ax1x.com/2021/08/19/fqx9ne.png" alt="fqx9ne.png"></a></p>
<h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><p>两种简单的特征构建方式</p>
<ul>
<li>多项式特征</li>
<li>领域知识特征  </li>
</ul>
<p>构造的特征是否有用不能轻易断定，只有试了之后看效果才能知道。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多项式特征通过scikit-learn polynomialfeatures构建</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为构建多项式特征构建新的df</span></span><br><span class="line"></span><br><span class="line">poly_features = app_train[[<span class="string">&#x27;EXT_SOURCE_1&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_2&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_3&#x27;</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>, <span class="string">&#x27;TARGET&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">poly_features_test = app_test[[<span class="string">&#x27;EXT_SOURCE_1&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_2&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_3&#x27;</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缺失值填充策略中位数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.impute <span class="keyword">import</span> SimpleImputer</span><br><span class="line"></span><br><span class="line">imputer = SimpleImputer(strategy = <span class="string">&#x27;median&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poly_target = poly_features[<span class="string">&#x27;TARGET&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poly_features = poly_features.drop(columns = [<span class="string">&#x27;TARGET&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行缺失值填充，注意以训练集为基准测试集作相同变化</span></span><br><span class="line"></span><br><span class="line">poly_features = imputer.fit_transform(poly_features)</span><br><span class="line"></span><br><span class="line">poly_features_test = imputer.transform(poly_features_test)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> PolynomialFeatures                             </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建多项式特征，定义度数</span></span><br><span class="line"></span><br><span class="line">poly_transformer = PolynomialFeatures(degree = <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练多项式特征</span></span><br><span class="line"></span><br><span class="line">poly_transformer.fit(poly_features)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成特征</span></span><br><span class="line"></span><br><span class="line">poly_features = poly_transformer.transform(poly_features)</span><br><span class="line"></span><br><span class="line">poly_features_test = poly_transformer.transform(poly_features_test)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Polynomial Features shape: &#x27;</span>, poly_features.shape)</span><br></pre></td></tr></table></figure>

<pre><code>Polynomial Features shape:  (307511, 35)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建特征很多使用get_feature_names为新特征命名,并预览前15个</span></span><br><span class="line"></span><br><span class="line">poly_transformer.get_feature_names(input_features = [<span class="string">&#x27;EXT_SOURCE_1&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_2&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_3&#x27;</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>])[:<span class="number">15</span>]</span><br></pre></td></tr></table></figure>




<pre><code>[&#39;1&#39;,
 &#39;EXT_SOURCE_1&#39;,
 &#39;EXT_SOURCE_2&#39;,
 &#39;EXT_SOURCE_3&#39;,
 &#39;DAYS_BIRTH&#39;,
 &#39;EXT_SOURCE_1^2&#39;,
 &#39;EXT_SOURCE_1 EXT_SOURCE_2&#39;,
 &#39;EXT_SOURCE_1 EXT_SOURCE_3&#39;,
 &#39;EXT_SOURCE_1 DAYS_BIRTH&#39;,
 &#39;EXT_SOURCE_2^2&#39;,
 &#39;EXT_SOURCE_2 EXT_SOURCE_3&#39;,
 &#39;EXT_SOURCE_2 DAYS_BIRTH&#39;,
 &#39;EXT_SOURCE_3^2&#39;,
 &#39;EXT_SOURCE_3 DAYS_BIRTH&#39;,
 &#39;DAYS_BIRTH^2&#39;]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查新特征与目标的相关度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为新特征建立df </span></span><br><span class="line"></span><br><span class="line">poly_features = pd.DataFrame(poly_features, </span><br><span class="line"></span><br><span class="line">                             columns = poly_transformer.get_feature_names([<span class="string">&#x27;EXT_SOURCE_1&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_2&#x27;</span>, </span><br><span class="line"></span><br><span class="line">                                                                           <span class="string">&#x27;EXT_SOURCE_3&#x27;</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入target列特征</span></span><br><span class="line"></span><br><span class="line">poly_features[<span class="string">&#x27;TARGET&#x27;</span>] = poly_target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看与target的相关性并排序</span></span><br><span class="line"></span><br><span class="line">poly_corrs = poly_features.corr()[<span class="string">&#x27;TARGET&#x27;</span>].sort_values()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看前十和后五项</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(poly_corrs.head(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(poly_corrs.tail(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<pre><code>EXT_SOURCE_2 EXT_SOURCE_3                -0.193939
EXT_SOURCE_1 EXT_SOURCE_2 EXT_SOURCE_3   -0.189605
EXT_SOURCE_2 EXT_SOURCE_3 DAYS_BIRTH     -0.181283
EXT_SOURCE_2^2 EXT_SOURCE_3              -0.176428
EXT_SOURCE_2 EXT_SOURCE_3^2              -0.172282
EXT_SOURCE_1 EXT_SOURCE_2                -0.166625
EXT_SOURCE_1 EXT_SOURCE_3                -0.164065
EXT_SOURCE_2                             -0.160295
EXT_SOURCE_2 DAYS_BIRTH                  -0.156873
EXT_SOURCE_1 EXT_SOURCE_2^2              -0.156867
Name: TARGET, dtype: float64
DAYS_BIRTH     -0.078239
DAYS_BIRTH^2   -0.076672
DAYS_BIRTH^3   -0.074273
TARGET          1.000000
1                    NaN
Name: TARGET, dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为测试特征新建df</span></span><br><span class="line"></span><br><span class="line">poly_features_test = pd.DataFrame(poly_features_test, </span><br><span class="line"></span><br><span class="line">                                  columns = poly_transformer.get_feature_names([<span class="string">&#x27;EXT_SOURCE_1&#x27;</span>, <span class="string">&#x27;EXT_SOURCE_2&#x27;</span>, </span><br><span class="line"></span><br><span class="line">                                                                                <span class="string">&#x27;EXT_SOURCE_3&#x27;</span>, <span class="string">&#x27;DAYS_BIRTH&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将多项式特征与训练特征合并，以sk_id_curr为引，how=left保留所有左表信息，将右表拼上来不能对其的部分用NAN填充</span></span><br><span class="line"></span><br><span class="line">poly_features[<span class="string">&#x27;SK_ID_CURR&#x27;</span>] = app_train[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_train_poly = app_train.merge(poly_features, on = <span class="string">&#x27;SK_ID_CURR&#x27;</span>, how = <span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样操作也作用于测试集</span></span><br><span class="line"></span><br><span class="line">poly_features_test[<span class="string">&#x27;SK_ID_CURR&#x27;</span>] = app_test[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_test_poly = app_test.merge(poly_features_test, on = <span class="string">&#x27;SK_ID_CURR&#x27;</span>, how = <span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将训练集和数据集的特征对齐</span></span><br><span class="line"></span><br><span class="line">app_train_poly, app_test_poly = app_train_poly.align(app_test_poly, join = <span class="string">&#x27;inner&#x27;</span>, axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看训练集测试集特征尺寸</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training data with polynomial features shape: &#x27;</span>, app_train_poly.shape)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Testing data with polynomial features shape:  &#x27;</span>, app_test_poly.shape)</span><br></pre></td></tr></table></figure>

<pre><code>Training data with polynomial features shape:  (307511, 275)
Testing data with polynomial features shape:   (48744, 275)
</code></pre>
<ul>
<li>领域知识特征<ul>
<li>CREDIT_INCOME_PERCENT: 信用金额相对于客户收入的百分比</li>
<li>ANNUITY_INCOME_PERCENT: 贷款年金相对于客户收入的百分比</li>
<li>CREDIT_TERM: 支付期限以月为单位(因为年金是每月到期的金额</li>
<li>DAYS_EMPLOYED_PERCENT: 雇佣天数占客户年龄的百分比</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app_train_domain = app_train.copy()</span><br><span class="line"></span><br><span class="line">app_test_domain = app_test.copy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造训练集相关特征</span></span><br><span class="line"></span><br><span class="line">app_train_domain[<span class="string">&#x27;CREDIT_INCOME_PERCENT&#x27;</span>] = app_train_domain[<span class="string">&#x27;AMT_CREDIT&#x27;</span>] / app_train_domain[<span class="string">&#x27;AMT_INCOME_TOTAL&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_train_domain[<span class="string">&#x27;ANNUITY_INCOME_PERCENT&#x27;</span>] = app_train_domain[<span class="string">&#x27;AMT_ANNUITY&#x27;</span>] / app_train_domain[<span class="string">&#x27;AMT_INCOME_TOTAL&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_train_domain[<span class="string">&#x27;CREDIT_TERM&#x27;</span>] = app_train_domain[<span class="string">&#x27;AMT_ANNUITY&#x27;</span>] / app_train_domain[<span class="string">&#x27;AMT_CREDIT&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_train_domain[<span class="string">&#x27;DAYS_EMPLOYED_PERCENT&#x27;</span>] = app_train_domain[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>] / app_train_domain[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试集上采取相同操作</span></span><br><span class="line"></span><br><span class="line">app_test_domain[<span class="string">&#x27;CREDIT_INCOME_PERCENT&#x27;</span>] = app_test_domain[<span class="string">&#x27;AMT_CREDIT&#x27;</span>] / app_test_domain[<span class="string">&#x27;AMT_INCOME_TOTAL&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_test_domain[<span class="string">&#x27;ANNUITY_INCOME_PERCENT&#x27;</span>] = app_test_domain[<span class="string">&#x27;AMT_ANNUITY&#x27;</span>] / app_test_domain[<span class="string">&#x27;AMT_INCOME_TOTAL&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_test_domain[<span class="string">&#x27;CREDIT_TERM&#x27;</span>] = app_test_domain[<span class="string">&#x27;AMT_ANNUITY&#x27;</span>] / app_test_domain[<span class="string">&#x27;AMT_CREDIT&#x27;</span>]</span><br><span class="line"></span><br><span class="line">app_test_domain[<span class="string">&#x27;DAYS_EMPLOYED_PERCENT&#x27;</span>] = app_test_domain[<span class="string">&#x27;DAYS_EMPLOYED&#x27;</span>] / app_test_domain[<span class="string">&#x27;DAYS_BIRTH&#x27;</span>]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可视化新特征</span></span><br><span class="line"></span><br><span class="line">plt.figure(figsize = (<span class="number">12</span>, <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历新特征</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, feature <span class="keyword">in</span> <span class="built_in">enumerate</span>([<span class="string">&#x27;CREDIT_INCOME_PERCENT&#x27;</span>, <span class="string">&#x27;ANNUITY_INCOME_PERCENT&#x27;</span>, <span class="string">&#x27;CREDIT_TERM&#x27;</span>, <span class="string">&#x27;DAYS_EMPLOYED_PERCENT&#x27;</span>]):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建子图，4行1列编号为i+1</span></span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">4</span>, <span class="number">1</span>, i + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 未违约kde图</span></span><br><span class="line"></span><br><span class="line">    sns.kdeplot(app_train_domain.loc[app_train_domain[<span class="string">&#x27;TARGET&#x27;</span>] == <span class="number">0</span>, feature], label = <span class="string">&#x27;target == 0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 违约kde图</span></span><br><span class="line"></span><br><span class="line">    sns.kdeplot(app_train_domain.loc[app_train_domain[<span class="string">&#x27;TARGET&#x27;</span>] == <span class="number">1</span>, feature], label = <span class="string">&#x27;target == 1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标签及坐标轴</span></span><br><span class="line"></span><br><span class="line">    plt.title(<span class="string">&#x27;Distribution of %s by Target Value&#x27;</span> % feature)</span><br><span class="line"></span><br><span class="line">    plt.xlabel(<span class="string">&#x27;%s&#x27;</span> % feature)</span><br><span class="line"></span><br><span class="line">    plt.ylabel(<span class="string">&#x27;Density&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    plt.legend()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">plt.tight_layout(h_pad = <span class="number">2.5</span>)</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqxFAA"><img src="https://z3.ax1x.com/2021/08/19/fqxFAA.png" alt="fqxFAA.png"></a></p>
<h2 id="Baseline"><a href="#Baseline" class="headerlink" title="Baseline"></a>Baseline</h2><p>首先对数据进行预处理：</p>
<ul>
<li><p>对象数据编码(encoding)</p>
</li>
<li><p>填充缺失值(imputation)</p>
</li>
<li><p>归一化特征范围(feature scaling)</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> MinMaxScaler</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.impute <span class="keyword">import</span> SimpleImputer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查训练集中是否包含target,包含的话删掉</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;TARGET&#x27;</span> <span class="keyword">in</span> app_train:</span><br><span class="line"></span><br><span class="line">    train = app_train.drop(columns = [<span class="string">&#x27;TARGET&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">    train = app_train.copy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取特征名</span></span><br><span class="line"></span><br><span class="line">features = <span class="built_in">list</span>(train.columns)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制测试集</span></span><br><span class="line"></span><br><span class="line">test = app_test.copy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对缺失值采取中位数填充策略</span></span><br><span class="line"></span><br><span class="line">imputer = SimpleImputer(strategy = <span class="string">&#x27;median&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 归一化特征至0-1区间</span></span><br><span class="line"></span><br><span class="line">scaler = MinMaxScaler(feature_range = (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过训练集训练填充参数</span></span><br><span class="line"></span><br><span class="line">imputer.fit(train)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 填充训练集和测试集</span></span><br><span class="line"></span><br><span class="line">train = imputer.transform(train)</span><br><span class="line"></span><br><span class="line">test = imputer.transform(app_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过训练集训练归一化参数，并且归一化训练集和测试集</span></span><br><span class="line"></span><br><span class="line">scaler.fit(train)</span><br><span class="line"></span><br><span class="line">train = scaler.transform(train)</span><br><span class="line"></span><br><span class="line">test = scaler.transform(test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看训练集和测试集的尺寸</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Training data shape: &#x27;</span>, train.shape)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Testing data shape: &#x27;</span>, test.shape)</span><br></pre></td></tr></table></figure>

<pre><code>Training data shape:  (307511, 240)
Testing data shape:  (48744, 240)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基线模型使用Scikit-Learn的logistic_regression</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化模型</span></span><br><span class="line"></span><br><span class="line">log_reg = LogisticRegression(C = <span class="number">0.0001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练模型</span></span><br><span class="line"></span><br><span class="line">log_reg.fit(train, train_labels)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 做预测，注意predict返回的是一个预测值，而predict_proba返回的是各个类别的概率，行概率和为1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二分类则得到([px1,px2],(dtype)) 分别表示预测为0的概率和预测为1的概率</span></span><br><span class="line"></span><br><span class="line">log_reg_pred = log_reg.predict_proba(test)</span><br><span class="line"></span><br><span class="line">log_reg_pred</span><br></pre></td></tr></table></figure>




<pre><code>array([[0.92148542, 0.07851458],
       [0.8620737 , 0.1379263 ],
       [0.91780633, 0.08219367],
       ...,
       [0.92277534, 0.07722466],
       [0.91761109, 0.08238891],
       [0.89786466, 0.10213534]])
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看每列概率对应的类别，可以看出与以上描述一致，第一个为0的概率第二个为1的概率</span></span><br><span class="line"></span><br><span class="line">log_reg.classes_</span><br></pre></td></tr></table></figure>




<pre><code>array([0, 1], dtype=int64)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于我们需要的是违约的概率即选择第二列结果</span></span><br><span class="line"></span><br><span class="line">log_reg_pred = log_reg.predict_proba(test)[:, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">log_reg_pred</span><br></pre></td></tr></table></figure>




<pre><code>array([0.07851458, 0.1379263 , 0.08219367, ..., 0.07722466, 0.08238891,
       0.10213534])
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Submission dataframe</span></span><br><span class="line"></span><br><span class="line">submit = app_test[[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">submit[<span class="string">&#x27;TARGET&#x27;</span>] = log_reg_pred</span><br><span class="line"></span><br><span class="line">submit.head()</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SK_ID_CURR</th>
      <th>TARGET</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>100001</td>
      <td>0.078515</td>
    </tr>
    <tr>
      <th>1</th>
      <td>100005</td>
      <td>0.137926</td>
    </tr>
    <tr>
      <th>2</th>
      <td>100013</td>
      <td>0.082194</td>
    </tr>
    <tr>
      <th>3</th>
      <td>100028</td>
      <td>0.080921</td>
    </tr>
    <tr>
      <th>4</th>
      <td>100038</td>
      <td>0.132618</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将结果保存为csv</span></span><br><span class="line"></span><br><span class="line">submit.to_csv(<span class="string">&#x27;./1_result/log_reg_baseline.csv&#x27;</span>, index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h2 id="随机森林模型"><a href="#随机森林模型" class="headerlink" title="随机森林模型"></a>随机森林模型</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立随机森林模型，n_estimators为树的数量，n_jobs设定工作的core数量，-1为所有core工作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># verbose为日志显示为0时不输出日志信息，为1时输出带进度条的日志信息，为2时无进度条得日志信息</span></span><br><span class="line"></span><br><span class="line">random_forest = RandomForestClassifier(n_estimators = <span class="number">100</span>, random_state = <span class="number">50</span>, verbose = <span class="number">1</span>, n_jobs = -<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在训练集上训练随机森林</span></span><br><span class="line"></span><br><span class="line">random_forest.fit(train, train_labels)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取特征重要性</span></span><br><span class="line"></span><br><span class="line">feature_importance_values = random_forest.feature_importances_</span><br><span class="line"></span><br><span class="line">feature_importances = pd.DataFrame(&#123;<span class="string">&#x27;feature&#x27;</span>: features, <span class="string">&#x27;importance&#x27;</span>: feature_importance_values&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在测试集上做预测，选择违约的概率</span></span><br><span class="line"></span><br><span class="line">predictions = random_forest.predict_proba(test)[:, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<pre><code>[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 8 concurrent workers.
[Parallel(n_jobs=-1)]: Done  34 tasks      | elapsed:   33.4s
[Parallel(n_jobs=-1)]: Done 100 out of 100 | elapsed:  1.4min finished
[Parallel(n_jobs=8)]: Using backend ThreadingBackend with 8 concurrent workers.
[Parallel(n_jobs=8)]: Done  34 tasks      | elapsed:    0.2s
[Parallel(n_jobs=8)]: Done 100 out of 100 | elapsed:    0.6s finished
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提交准备</span></span><br><span class="line"></span><br><span class="line">submit = app_test[[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">submit[<span class="string">&#x27;TARGET&#x27;</span>] = predictions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">submit.to_csv(<span class="string">&#x27;./1_result/random_forest_baseline.csv&#x27;</span>, index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证特征工程创建的特征是否有用，多项式特征</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取特征名</span></span><br><span class="line"></span><br><span class="line">poly_features_names = <span class="built_in">list</span>(app_train_poly.columns)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 中位数填补缺失值</span></span><br><span class="line"></span><br><span class="line">imputer = SimpleImputer(strategy = <span class="string">&#x27;median&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poly_features = imputer.fit_transform(app_train_poly)</span><br><span class="line"></span><br><span class="line">poly_features_test = imputer.transform(app_test_poly)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 归一化多项式特征</span></span><br><span class="line"></span><br><span class="line">scaler = MinMaxScaler(feature_range = (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poly_features = scaler.fit_transform(poly_features)</span><br><span class="line"></span><br><span class="line">poly_features_test = scaler.transform(poly_features_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立模型</span></span><br><span class="line"></span><br><span class="line">random_forest_poly = RandomForestClassifier(n_estimators = <span class="number">100</span>, random_state = <span class="number">50</span>, verbose = <span class="number">1</span>, n_jobs = -<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 训练模型</span></span><br><span class="line"></span><br><span class="line">random_forest_poly.fit(poly_features, train_labels)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 做预测</span></span><br><span class="line"></span><br><span class="line">predictions = random_forest_poly.predict_proba(poly_features_test)[:, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<pre><code>[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 8 concurrent workers.
[Parallel(n_jobs=-1)]: Done  34 tasks      | elapsed:   43.9s
[Parallel(n_jobs=-1)]: Done 100 out of 100 | elapsed:  2.0min finished
[Parallel(n_jobs=8)]: Using backend ThreadingBackend with 8 concurrent workers.
[Parallel(n_jobs=8)]: Done  34 tasks      | elapsed:    0.1s
[Parallel(n_jobs=8)]: Done 100 out of 100 | elapsed:    0.4s finished
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提交准备</span></span><br><span class="line"></span><br><span class="line">submit = app_test[[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">submit[<span class="string">&#x27;TARGET&#x27;</span>] = predictions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">submit.to_csv(<span class="string">&#x27;./1_result/random_forest_baseline_engineered.csv&#x27;</span>, index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试领域知识特征是否有用</span></span><br><span class="line"></span><br><span class="line">app_train_domain = app_train_domain.drop(columns = <span class="string">&#x27;TARGET&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">domain_features_names = <span class="built_in">list</span>(app_train_domain.columns)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 中位数填补缺失值</span></span><br><span class="line"></span><br><span class="line">imputer = SimpleImputer(strategy = <span class="string">&#x27;median&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">domain_features = imputer.fit_transform(app_train_domain)</span><br><span class="line"></span><br><span class="line">domain_features_test = imputer.transform(app_test_domain)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 归一化领域特征</span></span><br><span class="line"></span><br><span class="line">scaler = MinMaxScaler(feature_range = (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">domain_features = scaler.fit_transform(domain_features)</span><br><span class="line"></span><br><span class="line">domain_features_test = scaler.transform(domain_features_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立模型</span></span><br><span class="line"></span><br><span class="line">random_forest_domain = RandomForestClassifier(n_estimators = <span class="number">100</span>, random_state = <span class="number">50</span>, verbose = <span class="number">1</span>, n_jobs = -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练模型</span></span><br><span class="line"></span><br><span class="line">random_forest_domain.fit(domain_features, train_labels)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取特征重要性</span></span><br><span class="line"></span><br><span class="line">feature_importance_values_domain = random_forest_domain.feature_importances_</span><br><span class="line"></span><br><span class="line">feature_importances_domain = pd.DataFrame(&#123;<span class="string">&#x27;feature&#x27;</span>: domain_features_names, <span class="string">&#x27;importance&#x27;</span>: feature_importance_values_domain&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 做预测</span></span><br><span class="line"></span><br><span class="line">predictions = random_forest_domain.predict_proba(domain_features_test)[:, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<pre><code>[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 8 concurrent workers.
[Parallel(n_jobs=-1)]: Done  34 tasks      | elapsed:   36.1s
[Parallel(n_jobs=-1)]: Done 100 out of 100 | elapsed:  1.7min finished
[Parallel(n_jobs=8)]: Using backend ThreadingBackend with 8 concurrent workers.
[Parallel(n_jobs=8)]: Done  34 tasks      | elapsed:    0.3s
[Parallel(n_jobs=8)]: Done 100 out of 100 | elapsed:    0.8s finished
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提交准备</span></span><br><span class="line"></span><br><span class="line">submit = app_test[[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">submit[<span class="string">&#x27;TARGET&#x27;</span>] = predictions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">submit.to_csv(<span class="string">&#x27;./1_result/random_forest_baseline_domain.csv&#x27;</span>, index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_feature_importances</span>(<span class="params">df</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    绘制特征重要性，重要性越高越好</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        df (dataframe): 特征重要性. 包含`features`列和 `importance&#x27;列</span></span><br><span class="line"><span class="string">     </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        用图展示15个最重要的特征       </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据特征重要性排序，降序</span></span><br><span class="line"></span><br><span class="line">    df = df.sort_values(<span class="string">&#x27;importance&#x27;</span>, ascending = <span class="literal">False</span>).reset_index()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 归一化特征重要性</span></span><br><span class="line"></span><br><span class="line">    df[<span class="string">&#x27;importance_normalized&#x27;</span>] = df[<span class="string">&#x27;importance&#x27;</span>] / df[<span class="string">&#x27;importance&#x27;</span>].<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 条形图</span></span><br><span class="line"></span><br><span class="line">    plt.figure(figsize = (<span class="number">10</span>, <span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">    ax = plt.subplot()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将最重要的索引置顶</span></span><br><span class="line"></span><br><span class="line">    ax.barh(<span class="built_in">list</span>(<span class="built_in">reversed</span>(<span class="built_in">list</span>(df.index[:<span class="number">15</span>]))), </span><br><span class="line"></span><br><span class="line">            df[<span class="string">&#x27;importance_normalized&#x27;</span>].head(<span class="number">15</span>), </span><br><span class="line"></span><br><span class="line">            align = <span class="string">&#x27;center&#x27;</span>, edgecolor = <span class="string">&#x27;k&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置标签</span></span><br><span class="line"></span><br><span class="line">    ax.set_yticks(<span class="built_in">list</span>(<span class="built_in">reversed</span>(<span class="built_in">list</span>(df.index[:<span class="number">15</span>]))))</span><br><span class="line"></span><br><span class="line">    ax.set_yticklabels(df[<span class="string">&#x27;feature&#x27;</span>].head(<span class="number">15</span>))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 绘制标签</span></span><br><span class="line"></span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Normalized Importance&#x27;</span>); plt.title(<span class="string">&#x27;Feature Importances&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> df</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示默认特征的重要性</span></span><br><span class="line"></span><br><span class="line">feature_importances_sorted = plot_feature_importances(feature_importances)</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqxC0H"><img src="https://z3.ax1x.com/2021/08/19/fqxC0H.png" alt="fqxC0H.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示领域特征重要性</span></span><br><span class="line"></span><br><span class="line">feature_importances_domain_sorted = plot_feature_importances(feature_importances_domain)</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqxP7d"><img src="https://z3.ax1x.com/2021/08/19/fqxP7d.png" alt="fqxP7d.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> KFold</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> roc_auc_score</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">model</span>(<span class="params">features, test_features, encoding = <span class="string">&#x27;ohe&#x27;</span>, n_folds = <span class="number">5</span></span>):</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;lightgbm交叉验证</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    --------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        features (pd.DataFrame): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            训练集特征</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        test_features (pd.DataFrame): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            测试集特征</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        encoding (str, default = &#x27;ohe&#x27;): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            独热编码，le为标签编码</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            n_folds (int, default = 5): 交叉验证折数默认为5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Return</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    --------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        submission (pd.DataFrame): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            由`SK_ID_CURR` 和 `TARGET`组成的DF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        feature_importances (pd.DataFrame): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            特征重要性</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        valid_metrics (pd.DataFrame): </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            每折验证的ROC和AUC以及最终的性能值</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取 ids</span></span><br><span class="line"></span><br><span class="line">    train_ids = features[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    test_ids = test_features[<span class="string">&#x27;SK_ID_CURR&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取训练集标签</span></span><br><span class="line"></span><br><span class="line">    labels = features[<span class="string">&#x27;TARGET&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 只保留特征</span></span><br><span class="line"></span><br><span class="line">    features = features.drop(columns = [<span class="string">&#x27;SK_ID_CURR&#x27;</span>, <span class="string">&#x27;TARGET&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    test_features = test_features.drop(columns = [<span class="string">&#x27;SK_ID_CURR&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 独热编码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> encoding == <span class="string">&#x27;ohe&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        features = pd.get_dummies(features)</span><br><span class="line"></span><br><span class="line">        test_features = pd.get_dummies(test_features)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 按列对齐DF</span></span><br><span class="line"></span><br><span class="line">        features, test_features = features.align(test_features, join = <span class="string">&#x27;inner&#x27;</span>, axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 无分类索引记录</span></span><br><span class="line"></span><br><span class="line">        cat_indices = <span class="string">&#x27;auto&#x27;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 整数标签编码</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> encoding == <span class="string">&#x27;le&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建标签编码</span></span><br><span class="line"></span><br><span class="line">        label_encoder = LabelEncoder()</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 用于存储分类索引的列表</span></span><br><span class="line"></span><br><span class="line">        cat_indices = []</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历每列</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, col <span class="keyword">in</span> <span class="built_in">enumerate</span>(features):</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> features[col].dtype == <span class="string">&#x27;object&#x27;</span>:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 将分类特性映射到整数</span></span><br><span class="line"></span><br><span class="line">                features[col] = label_encoder.fit_transform(np.array(features[col].astype(<span class="built_in">str</span>)).reshape((-<span class="number">1</span>,)))</span><br><span class="line"></span><br><span class="line">                test_features[col] = label_encoder.transform(np.array(test_features[col].astype(<span class="built_in">str</span>)).reshape((-<span class="number">1</span>,)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 记录分类索引</span></span><br><span class="line"></span><br><span class="line">                cat_indices.append(i)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若标签编码无效则捕获错误</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Encoding must be either &#x27;ohe&#x27; or &#x27;le&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Training Data Shape: &#x27;</span>, features.shape)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Testing Data Shape: &#x27;</span>, test_features.shape)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取特征名称</span></span><br><span class="line"></span><br><span class="line">    feature_names = <span class="built_in">list</span>(features.columns)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将DF转化为np数组</span></span><br><span class="line"></span><br><span class="line">    features = np.array(features)</span><br><span class="line"></span><br><span class="line">    test_features = np.array(test_features)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建交叉验证对象</span></span><br><span class="line"></span><br><span class="line">    k_fold = KFold(n_splits = n_folds, shuffle = <span class="literal">True</span>, random_state = <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立空数组用于记录特征重要性</span></span><br><span class="line"></span><br><span class="line">    feature_importance_values = np.zeros(<span class="built_in">len</span>(feature_names))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立空数组用于保存预测值</span></span><br><span class="line"></span><br><span class="line">    test_predictions = np.zeros(test_features.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于交叉验证预测的空数组</span></span><br><span class="line"></span><br><span class="line">    out_of_fold = np.zeros(features.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于记录验证和训练分数的列表</span></span><br><span class="line"></span><br><span class="line">    valid_scores = []</span><br><span class="line"></span><br><span class="line">    train_scores = []</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历每折</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> train_indices, valid_indices <span class="keyword">in</span> k_fold.split(features):</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每折的训练数据</span></span><br><span class="line"></span><br><span class="line">        train_features, train_labels = features[train_indices], labels[train_indices]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每折的验证数据</span></span><br><span class="line"></span><br><span class="line">        valid_features, valid_labels = features[valid_indices], labels[valid_indices]</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建模型</span></span><br><span class="line"></span><br><span class="line">        model = lgb.LGBMClassifier(n_estimators=<span class="number">10000</span>, objective = <span class="string">&#x27;binary&#x27;</span>, </span><br><span class="line"></span><br><span class="line">                                   class_weight = <span class="string">&#x27;balanced&#x27;</span>, learning_rate = <span class="number">0.05</span>, </span><br><span class="line"></span><br><span class="line">                                   reg_alpha = <span class="number">0.1</span>, reg_lambda = <span class="number">0.1</span>, </span><br><span class="line"></span><br><span class="line">                                   subsample = <span class="number">0.8</span>, n_jobs = -<span class="number">1</span>, random_state = <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 训练模型</span></span><br><span class="line"></span><br><span class="line">        model.fit(train_features, train_labels, eval_metric = <span class="string">&#x27;auc&#x27;</span>,</span><br><span class="line"></span><br><span class="line">                  eval_set = [(valid_features, valid_labels), (train_features, train_labels)],</span><br><span class="line"></span><br><span class="line">                  eval_names = [<span class="string">&#x27;valid&#x27;</span>, <span class="string">&#x27;train&#x27;</span>], categorical_feature = cat_indices,</span><br><span class="line"></span><br><span class="line">                  early_stopping_rounds = <span class="number">100</span>, verbose = <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录最好的代数</span></span><br><span class="line"></span><br><span class="line">        best_iteration = model.best_iteration_</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录特征重要性</span></span><br><span class="line"></span><br><span class="line">        feature_importance_values += model.feature_importances_ / k_fold.n_splits</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 做预测</span></span><br><span class="line"></span><br><span class="line">        test_predictions += model.predict_proba(test_features, num_iteration = best_iteration)[:, <span class="number">1</span>] / k_fold.n_splits</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录折外预测结果</span></span><br><span class="line"></span><br><span class="line">        out_of_fold[valid_indices] = model.predict_proba(valid_features, num_iteration = best_iteration)[:, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录最好的得分</span></span><br><span class="line"></span><br><span class="line">        valid_score = model.best_score_[<span class="string">&#x27;valid&#x27;</span>][<span class="string">&#x27;auc&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        train_score = model.best_score_[<span class="string">&#x27;train&#x27;</span>][<span class="string">&#x27;auc&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        valid_scores.append(valid_score)</span><br><span class="line"></span><br><span class="line">        train_scores.append(train_score)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 清理内存</span></span><br><span class="line"></span><br><span class="line">        gc.enable()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">del</span> model, train_features, valid_features</span><br><span class="line"></span><br><span class="line">        gc.collect()</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提交准备</span></span><br><span class="line"></span><br><span class="line">    submission = pd.DataFrame(&#123;<span class="string">&#x27;SK_ID_CURR&#x27;</span>: test_ids, <span class="string">&#x27;TARGET&#x27;</span>: test_predictions&#125;)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 特征重要性</span></span><br><span class="line"></span><br><span class="line">    feature_importances = pd.DataFrame(&#123;<span class="string">&#x27;feature&#x27;</span>: feature_names, <span class="string">&#x27;importance&#x27;</span>: feature_importance_values&#125;)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 交叉验证整体得分</span></span><br><span class="line"></span><br><span class="line">    valid_auc = roc_auc_score(labels, out_of_fold)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将得分加入矩阵</span></span><br><span class="line"></span><br><span class="line">    valid_scores.append(valid_auc)</span><br><span class="line"></span><br><span class="line">    train_scores.append(np.mean(train_scores))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建验证分数的DF</span></span><br><span class="line"></span><br><span class="line">    fold_names = <span class="built_in">list</span>(<span class="built_in">range</span>(n_folds))</span><br><span class="line"></span><br><span class="line">    fold_names.append(<span class="string">&#x27;overall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    metrics = pd.DataFrame(&#123;<span class="string">&#x27;fold&#x27;</span>: fold_names,</span><br><span class="line"></span><br><span class="line">                            <span class="string">&#x27;train&#x27;</span>: train_scores,</span><br><span class="line"></span><br><span class="line">                            <span class="string">&#x27;valid&#x27;</span>: valid_scores&#125;) </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> submission, feature_importances, metrics</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">submission, fi, metrics = model(app_train, app_test)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Baseline metrics&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(metrics)</span><br></pre></td></tr></table></figure>

<pre><code>Training Data Shape:  (307511, 239)
Testing Data Shape:  (48744, 239)
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.798723    train&#39;s binary_logloss: 0.547797    valid&#39;s auc: 0.755039    valid&#39;s binary_logloss: 0.563266
[400]    train&#39;s auc: 0.82838    train&#39;s binary_logloss: 0.518334    valid&#39;s auc: 0.755107    valid&#39;s binary_logloss: 0.545575
Early stopping, best iteration is:
[315]    train&#39;s auc: 0.816657    train&#39;s binary_logloss: 0.530116    valid&#39;s auc: 0.755215    valid&#39;s binary_logloss: 0.552627
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.798409    train&#39;s binary_logloss: 0.548179    valid&#39;s auc: 0.758332    valid&#39;s binary_logloss: 0.563587
[400]    train&#39;s auc: 0.828244    train&#39;s binary_logloss: 0.518308    valid&#39;s auc: 0.758563    valid&#39;s binary_logloss: 0.545588
Early stopping, best iteration is:
[317]    train&#39;s auc: 0.8169    train&#39;s binary_logloss: 0.529878    valid&#39;s auc: 0.758754    valid&#39;s binary_logloss: 0.552413
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.797648    train&#39;s binary_logloss: 0.549331    valid&#39;s auc: 0.763246    valid&#39;s binary_logloss: 0.564236
Early stopping, best iteration is:
[264]    train&#39;s auc: 0.808111    train&#39;s binary_logloss: 0.539063    valid&#39;s auc: 0.76363    valid&#39;s binary_logloss: 0.557905
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.798855    train&#39;s binary_logloss: 0.547952    valid&#39;s auc: 0.757131    valid&#39;s binary_logloss: 0.562234
Early stopping, best iteration is:
[280]    train&#39;s auc: 0.811887    train&#39;s binary_logloss: 0.535139    valid&#39;s auc: 0.757583    valid&#39;s binary_logloss: 0.554287
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.797918    train&#39;s binary_logloss: 0.548584    valid&#39;s auc: 0.758065    valid&#39;s binary_logloss: 0.564721
Early stopping, best iteration is:
[287]    train&#39;s auc: 0.811617    train&#39;s binary_logloss: 0.535146    valid&#39;s auc: 0.758344    valid&#39;s binary_logloss: 0.556636
Baseline metrics
      fold     train     valid
0        0  0.816657  0.755215
1        1  0.816900  0.758754
2        2  0.808111  0.763630
3        3  0.811887  0.757583
4        4  0.811617  0.758344
5  overall  0.813034  0.758705
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fi_sorted = plot_feature_importances(fi)</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqxktI"><img src="https://z3.ax1x.com/2021/08/19/fqxktI.png" alt="fqxktI.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">submission.to_csv(<span class="string">&#x27;./1_result/baseline_lgb.csv&#x27;</span>, index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app_train_domain[<span class="string">&#x27;TARGET&#x27;</span>] = train_labels</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试领域知识特征</span></span><br><span class="line"></span><br><span class="line">submission_domain, fi_domain, metrics_domain = model(app_train_domain, app_test_domain)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Baseline with domain knowledge features metrics&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(metrics_domain)</span><br></pre></td></tr></table></figure>

<pre><code>Training Data Shape:  (307511, 243)
Testing Data Shape:  (48744, 243)
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.804779    train&#39;s binary_logloss: 0.541283    valid&#39;s auc: 0.762511    valid&#39;s binary_logloss: 0.557227
Early stopping, best iteration is:
[268]    train&#39;s auc: 0.815523    train&#39;s binary_logloss: 0.530413    valid&#39;s auc: 0.763069    valid&#39;s binary_logloss: 0.550276
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.804016    train&#39;s binary_logloss: 0.542318    valid&#39;s auc: 0.765768    valid&#39;s binary_logloss: 0.557819
Early stopping, best iteration is:
[218]    train&#39;s auc: 0.807075    train&#39;s binary_logloss: 0.539112    valid&#39;s auc: 0.766062    valid&#39;s binary_logloss: 0.555952
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.8038    train&#39;s binary_logloss: 0.542856    valid&#39;s auc: 0.7703    valid&#39;s binary_logloss: 0.557925
[400]    train&#39;s auc: 0.834559    train&#39;s binary_logloss: 0.511454    valid&#39;s auc: 0.770511    valid&#39;s binary_logloss: 0.538558
Early stopping, best iteration is:
[383]    train&#39;s auc: 0.832138    train&#39;s binary_logloss: 0.514008    valid&#39;s auc: 0.77073    valid&#39;s binary_logloss: 0.54009
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.804603    train&#39;s binary_logloss: 0.541718    valid&#39;s auc: 0.765497    valid&#39;s binary_logloss: 0.556274
Early stopping, best iteration is:
[238]    train&#39;s auc: 0.8111    train&#39;s binary_logloss: 0.535149    valid&#39;s auc: 0.765884    valid&#39;s binary_logloss: 0.552351
Training until validation scores don&#39;t improve for 100 rounds
[200]    train&#39;s auc: 0.804782    train&#39;s binary_logloss: 0.541397    valid&#39;s auc: 0.765076    valid&#39;s binary_logloss: 0.558641
Early stopping, best iteration is:
[290]    train&#39;s auc: 0.819404    train&#39;s binary_logloss: 0.526653    valid&#39;s auc: 0.765249    valid&#39;s binary_logloss: 0.549657
Baseline with domain knowledge features metrics
      fold     train     valid
0        0  0.815523  0.763069
1        1  0.807075  0.766062
2        2  0.832138  0.770730
3        3  0.811100  0.765884
4        4  0.819404  0.765249
5  overall  0.817048  0.766186
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fi_sorted = plot_feature_importances(fi_domain)</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fqxV9P"><img src="https://z3.ax1x.com/2021/08/19/fqxV9P.png" alt="fqxV9P.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">submission_domain.to_csv(<span class="string">&#x27;./1_result/baseline_lgb_domain_features.csv&#x27;</span>, index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<hr>
<p>本文提及的数据集下载地址：<br>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Dlxp_C8H7Rjf0OKorSRQ0A">https://pan.baidu.com/s/1Dlxp_C8H7Rjf0OKorSRQ0A</a><br>提取码：1111</p>
<hr>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          Donate
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>Copyright： </strong>
          
          Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://woody0819.github.io/2021/08/20/Home%20Credit%20Default%20Risk/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kaggle/" rel="tag">Kaggle</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2021/08/20/Telco%20Customer%20Churn/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Telco Customer Churn
          
        </div>
      </a>
    
    
      <a href="/2021/08/18/DA%20general%20process/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">数据分析一般过程</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "Q0bUd4kz7kv9o8cLXDqyYijd-gzGzoHsz",
    app_key: "3xet4X44IIsU9kGHHuQiOa4B",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
    enableQQ: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2019-2022
        <i class="ri-heart-fill heart_icon"></i> Woody
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        Powered by <a href="https://hexo.io" target="_blank">Hexo</a>
        <span class="division">|</span>
        Theme - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>Visitors:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>Views:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Woody"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://woody0819.lofter.com/">旅途</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/guestbook">留言</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.png">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.png">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
  </div>
</body>

</html>